# Инструкция для тестирования на эмуляторе

## Подготовка эмулятора

### 1. Создание эмулятора

1. Откройте Android Studio
2. Tools → Device Manager
3. Create Device
4. Выберите устройство (рекомендуется Pixel 5 или аналогичное)
5. Выберите системный образ (рекомендуется Android 10+ API 29+)
6. Завершите создание

### 2. Установка Яндекс.Навигатора

**Вариант 1: Через Play Store (если доступен)**
1. Запустите эмулятор
2. Откройте Play Store
3. Найдите "Яндекс.Навигатор"
4. Установите

**Вариант 2: Через APK файл**
1. Скачайте APK Яндекс.Навигатора
2. Перетащите APK в окно эмулятора
3. Или используйте команду:
   ```bash
   adb install path/to/yandex.navigator.apk
   ```

### 3. Настройка разрешений

1. Запустите Яндекс.Навигатор
2. Предоставьте все необходимые разрешения:
   - Местоположение
   - Файлы и медиа
   - Уведомления

## Запуск приложения

### 1. Сборка проекта

```bash
cd development/projects/TiggoBridgeService
./gradlew assembleDebug
```

### 2. Установка на эмулятор

```bash
./gradlew installDebug
```

Или через Android Studio:
- Run → Run 'app'

### 3. Проверка установки

```bash
adb shell pm list packages | grep tiggo
```

Должно показать: `package:com.desaysv.tiggo.bridge`

## Тестирование

### Шаг 1: Запуск BridgeService

1. Откройте приложение TiggoBridgeService
2. Перейдите в настройки
3. Убедитесь, что выбран "Яндекс.Навигатор" (ru.yandex.yandexnavi)
4. Запустите сервис (если есть кнопка) или он запустится автоматически

### Шаг 2: Проверка логов

```bash
# Фильтр логов по нашему приложению
adb logcat | grep -E "TiggoBridgeService|YandexNavigatorDataExtractor|ReflectionHelper|SystemSender"

# Или более детально
adb logcat -s TiggoBridgeService:D YandexNavigatorDataExtractor:D ReflectionHelper:D SystemSender:D
```

### Шаг 3: Запуск навигации

1. Откройте Яндекс.Навигатор
2. Постройте маршрут (выберите точку назначения)
3. Нажмите "Поехали" для начала навигации

### Шаг 4: Проверка данных

В логах должны появиться сообщения:

```
YandexNavigatorDataExtractor: === Инициализация YandexNavigatorDataExtractor ===
YandexNavigatorDataExtractor: ✓ Навигатор установлен: ru.yandex.yandexnavi
YandexNavigatorDataExtractor: ✓ Навигатор запущен: ru.yandex.yandexnavi
YandexNavigatorDataExtractor: ✓ NotificationDataManager получен: ...
YandexNavigatorDataExtractor: ✓ NotificationDataManager валиден
YandexNavigatorDataExtractor: === Данные NotificationData ===
YandexNavigatorDataExtractor:   title: Поверните налево через 200 м
YandexNavigatorDataExtractor:   distanceLeft: 5.2 км
YandexNavigatorDataExtractor:   timeLeft: 15 мин
YandexNavigatorDataExtractor: === Данные отправлены в систему ===
SystemSender: Навигационные данные отправлены
```

## Отладка проблем

### Проблема: "Навигатор не установлен"

**Решение:**
1. Проверьте package name в настройках
2. Установите Яндекс.Навигатор
3. Проверьте: `adb shell pm list packages | grep yandex`

### Проблема: "NotificationDataManager == null"

**Возможные причины:**
1. Навигатор не запущен
2. Навигация не активна (не построен маршрут)
3. Версия навигатора не поддерживается

**Решение:**
1. Запустите Яндекс.Навигатор
2. Постройте маршрут и начните навигацию
3. Проверьте логи для деталей

### Проблема: "NotificationDataManager не валиден"

**Причина:** Навигация не активна

**Решение:**
1. Убедитесь, что маршрут построен
2. Нажмите "Поехали" для начала навигации
3. Дождитесь начала движения

### Проблема: "NotificationData == null"

**Причина:** Данные еще не готовы

**Решение:**
1. Подождите несколько секунд
2. Убедитесь, что навигация активна
3. Проверьте, что GPS включен на эмуляторе

## Проверка отправки данных в систему

### Мониторинг Broadcast Intent

```bash
# Мониторинг всех broadcast intent
adb shell am broadcast -a turbodog.navigation.system.message --es CODE 201

# Или через logcat
adb logcat | grep "turbodog.navigation.system.message"
```

### Проверка через BroadcastReceiver (если есть тестовое приложение)

Создайте тестовое приложение с BroadcastReceiver для проверки получения данных.

## Полезные команды

### Проверка запущенных процессов

```bash
adb shell ps | grep yandex
```

### Проверка установленных пакетов

```bash
adb shell pm list packages | grep yandex
```

### Очистка логов

```bash
adb logcat -c
```

### Экспорт логов в файл

```bash
adb logcat > logs.txt
```

### Фильтр по уровню логирования

```bash
# Только ошибки
adb logcat *:E

# Ошибки и предупреждения
adb logcat *:W

# Все уровни для нашего приложения
adb logcat TiggoBridgeService:* YandexNavigatorDataExtractor:* ReflectionHelper:* SystemSender:*
```

## Ожидаемое поведение

1. ✅ Приложение запускается без ошибок
2. ✅ BridgeService инициализируется
3. ✅ YandexNavigatorDataExtractor находит NotificationDataManager
4. ✅ Подписка на обновления успешна
5. ✅ При начале навигации данные начинают поступать
6. ✅ Данные отправляются в систему через broadcast

## Следующие шаги после успешного тестирования

1. Проверить формат данных (соответствие TurboDog)
2. Проверить частоту обновлений
3. Протестировать на реальном устройстве
4. Оптимизировать производительность

