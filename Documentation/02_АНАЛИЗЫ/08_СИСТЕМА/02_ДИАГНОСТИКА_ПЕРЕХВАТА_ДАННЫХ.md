# Диагностика перехвата данных навигации

## Текущее состояние (13.11.2024)

### ✅ Что работает:

1. **Broadcast Intent система**:
   - Наш `BridgeService` успешно зарегистрирован как получатель `turbodog.navigation.system.message`
   - Системный сервис `com.desaysv.mapservice` (uid=1000, системный) также слушает этот Broadcast
   - **Вывод**: `com.desaysv.mapservice` - это мост между Android и QNX!

2. **Уведомления от Yandex Maps**:
   - Уведомление от `ru.yandex.yandexmaps` присутствует в системе
   - ID: 2, category: navigation, importance: LOW
   - Extras содержат: `android.title`, `android.text`, `android.subText`

### ❌ Что не работает:

1. **NotificationListenerService НЕ активен**:
   - `enabled_notification_listeners` пустой
   - `NavigationNotificationListener` не создается (нет логов)
   - `onNotificationPosted` не вызывается

2. **Нет логов от нашего приложения**:
   - Нет логов о создании `NavigationNotificationListener`
   - Нет логов о перехвате уведомлений
   - Нет логов о отправке Broadcast Intent'ов от `SystemSender`

## Важные находки

### 1. Системный мост к QNX

```
* ReceiverList{ccf2249 2576 com.desaysv.mapservice/1000/u0 remote:36a3050}
  app=2576:com.desaysv.mapservice/1000 pid=2576 uid=1000 user=0
  Filter #0: BroadcastFilter{e1a074e}
    Action: "turbodog.navigation.system.message"
```

**Вывод**: `com.desaysv.mapservice` (системный сервис, uid=1000) - это мост между Android и QNX. Он получает Broadcast `turbodog.navigation.system.message` и передает данные на приборную панель.

### 2. Структура уведомления Yandex Maps

```
NotificationRecord:
  pkg=ru.yandex.yandexmaps
  id=2
  category=navigation
  importance=2 (LOW)
  extras={
    android.title=String
    android.text=null
    android.subText=null
    android.reduced.images=Boolean (true)
    android.showChronometer=Boolean (false)
    android.progress=Integer (0)
    android.progressMax=Integer (0)
    android.showWhen=Boolean (false)
    android.colorized=Boolean (true)
  }
```

**Проблема**: `android.text` и `android.subText` равны `null` в dumpsys, но это может быть из-за того, что данные в `bigContentView` или `headsUpContentView`.

## План действий

### 1. Включить NotificationListenerService

```bash
# Проверить текущее состояние
adb shell settings get secure enabled_notification_listeners

# Включить через ADB
adb shell settings put secure enabled_notification_listeners com.desaysv.tiggo.bridge/com.desaysv.tiggo.bridge.notification.NavigationNotificationListener

# Или добавить к существующим (если есть)
adb shell settings put secure enabled_notification_listeners "existing:com.desaysv.tiggo.bridge/com.desaysv.tiggo.bridge.notification.NavigationNotificationListener"
```

### 2. Проверить, отправляются ли наши Broadcast'ы

Нужно добавить логирование в `SystemSender.sendNavigationData()` чтобы видеть, что мы отправляем.

### 3. Изучить com.desaysv.mapservice

Этот сервис - ключ к пониманию, как данные передаются в QNX. Нужно:
- Проверить его логи
- Понять формат данных, который он ожидает
- Убедиться, что мы отправляем данные в правильном формате

### 4. Проверить содержимое уведомления Yandex Maps

Возможно, данные находятся в `bigContentView` или `headsUpContentView`, а не в `extras`. Нужно проверить эти поля в `onNotificationPosted`.

## Выполненные действия

1. ✅ **Включен NotificationListenerService через ADB**:
   ```bash
   adb shell settings put secure enabled_notification_listeners com.desaysv.tiggo.bridge/com.desaysv.tiggo.bridge.notification.NavigationNotificationListener
   ```

2. ✅ **Добавлено детальное логирование**:
   - `SystemSender` теперь логирует все отправляемые Broadcast Intent'ы с деталями
   - `NavigationNotificationListener` логирует все ключи в extras уведомлений
   - Добавлена проверка `bigContentView` и `headsUpContentView`

3. ✅ **Обнаружен системный мост к QNX**:
   - `com.desaysv.mapservice` (uid=1000, системный сервис) слушает `turbodog.navigation.system.message`
   - Это мост между Android и QNX, который передает данные на приборную панель (Display 1)

4. ✅ **Приложение пересобрано** с улучшенным логированием

## Следующие шаги

1. ⏳ **Установить обновленное приложение** на ГУ
2. ⏳ **Перезапустить приложение** (или систему) для активации NotificationListenerService
3. ⏳ **Запустить навигацию** в Yandex Maps и построить маршрут
4. ⏳ **Проверить логи** на перехват уведомлений и отправку Broadcast'ов

## Команды для проверки

```bash
# Проверить, включен ли NotificationListenerService
adb shell settings get secure enabled_notification_listeners

# Проверить логи NavigationNotificationListener
adb logcat | grep -E "(NavNotificationListener|onNotificationPosted)"

# Проверить логи SystemSender (отправка Broadcast'ов)
adb logcat | grep -E "(SystemSender|turbodog.navigation)"

# Проверить все логи приложения
adb logcat | grep "com.desaysv.tiggo.bridge"
```

