# Архитектура интеграции Yandex Navigator с QNX

## Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────────┐
│                    Приложения Android                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   Media      │  │      BT      │  │  Navigator   │         │
│  │  (музыка)    │  │  (телефон)   │  │  (навигация) │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                  │                  │                  │
│         │  Intent/Broadcast │                  │                  │
│         └──────────────────┴──────────────────┘                  │
│                            │                                      │
│                            ▼                                      │
│                  ┌──────────────────┐                            │
│                  │ TiggoBridgeService│                            │
│                  │   (единый мост)  │                            │
│                  └────────┬─────────┘                            │
│                           │                                       │
└───────────────────────────┼───────────────────────────────────────┘
                            │
                            │ Broadcast Intent
                            │ (формат TurboDog)
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Система QNX                                 │
│                  (приборная панель)                              │
└─────────────────────────────────────────────────────────────────┘
```

## Принцип работы

### 1. Единая точка интеграции

**TiggoBridgeService** - это единый мост между Android приложениями и QNX системой.

**Преимущества:**
- ✅ Централизованная обработка данных
- ✅ Единый формат обмена с QNX
- ✅ Легче поддерживать и обновлять
- ✅ Соответствует принципу разделения ответственности

### 2. Поток данных от Yandex Navigator

```
Yandex Navigator
    │
    │ NotificationDataManager обновляется
    │
    ▼
TiggoBridgeSender (в навигаторе)
    │
    │ Intent: "com.desaysv.tiggo.bridge.NAVIGATION_DATA"
    │ Extras: title, subtitle, distanceLeft, timeLeft, timeOfArrival
    │
    ▼
TiggoBridgeService (наш мост)
    │
    │ Преобразование в NavigationData
    │ Парсинг данных
    │
    ▼
SystemSender
    │
    │ Broadcast: "turbodog.navigation.system.message"
    │ Format: TurboDog (CODE=201, TURN_TYPE, TURN_DIST, etc.)
    │
    ▼
QNX System
    │
    ▼
Приборная панель
```

## Детали реализации

### Шаг 1: Модификация Yandex Navigator

**Файл:** `TiggoBridgeSender.java` (в пакете `ru.yandex.yandexmaps.bridge`)

**Функции:**
1. Подключается к `NotificationDataManager`
2. Слушает обновления данных навигации
3. Отправляет данные в `TiggoBridgeService` через Intent

**Код отправки:**
```java
Intent intent = new Intent("com.desaysv.tiggo.bridge.NAVIGATION_DATA");
intent.setPackage("com.desaysv.tiggo.bridge");
intent.putExtra("title", data.getTitle());
intent.putExtra("subtitle", data.getSubtitle());
intent.putExtra("distanceLeft", data.getDistanceLeft());
intent.putExtra("timeLeft", data.getTimeLeft());
intent.putExtra("timeOfArrival", data.getTimeOfArrival());
context.sendBroadcast(intent);
```

### Шаг 2: TiggoBridgeService получает данные

**BroadcastReceiver:** `navigatorDataReceiver` в `BridgeService.java`

**Функции:**
1. Слушает Intent `"com.desaysv.tiggo.bridge.NAVIGATION_DATA"`
2. Извлекает данные из Intent extras
3. Преобразует в `NavigationData`
4. Отправляет в QNX через `SystemSender`

**Код получения:**
```java
private BroadcastReceiver navigatorDataReceiver = new BroadcastReceiver() {
    @Override
    public void onReceive(Context context, Intent intent) {
        if ("com.desaysv.tiggo.bridge.NAVIGATION_DATA".equals(intent.getAction())) {
            String title = intent.getStringExtra("title");
            String subtitle = intent.getStringExtra("subtitle");
            // ... извлечение данных ...
            
            NavigationData data = convertNotificationDataToNavigationData(...);
            systemSender.sendNavigationData(data);
        }
    }
};
```

### Шаг 3: Преобразование в формат TurboDog

**Класс:** `SystemSender.java`

**Функции:**
1. Принимает `NavigationData`
2. Преобразует в формат TurboDog
3. Отправляет в QNX через Broadcast

**Формат TurboDog:**
```java
Intent intent = new Intent("turbodog.navigation.system.message");
intent.putExtra("CODE", 201);
intent.putExtra("TURN_TYPE", turnType);
intent.putExtra("TURN_DIST", turnDist);
intent.putExtra("TURN_TIME", turnTime);
intent.putExtra("REMAINING_DIST", remainingDist);
intent.putExtra("REMAINING_TIME", remainingTime);
intent.putExtra("CURRENT_ROAD", currentRoad);
intent.putExtra("NEXT_ROAD", nextRoad);
intent.putExtra("ARRIVE_TIME", arriveTime);
context.sendBroadcast(intent);
```

## Преимущества архитектуры

### 1. Разделение ответственности

- **Yandex Navigator:** Только отправка данных (не знает о QNX)
- **TiggoBridgeService:** Преобразование и маршрутизация (знает оба формата)
- **QNX System:** Только получение данных (не знает об Android)

### 2. Легкость поддержки

- Изменения в формате QNX → меняем только `SystemSender`
- Изменения в навигаторе → меняем только `TiggoBridgeSender`
- Добавление новых приложений → просто добавляем новый BroadcastReceiver

### 3. Масштабируемость

Легко добавить другие приложения:
- Media → отправляет данные о треках
- BT → отправляет данные о звонках
- Все через один мост → `TiggoBridgeService`

## Сравнение с альтернативными подходами

### ❌ Плохо: Прямая интеграция навигатора с QNX

```
Yandex Navigator → QNX (напрямую)
```

**Проблемы:**
- Навигатор должен знать формат QNX
- Дублирование кода в каждом приложении
- Сложно поддерживать

### ✅ Хорошо: Через единый мост

```
Yandex Navigator → TiggoBridgeService → QNX
```

**Преимущества:**
- Единая точка интеграции
- Легко поддерживать
- Масштабируемо

## Регистрация BroadcastReceiver

**В AndroidManifest.xml:**
```xml
<!-- Не требуется! BroadcastReceiver регистрируется программно в Service -->
```

**В BridgeService.onCreate():**
```java
IntentFilter navigatorFilter = new IntentFilter("com.desaysv.tiggo.bridge.NAVIGATION_DATA");
registerReceiver(navigatorDataReceiver, navigatorFilter);
```

**В BridgeService.onDestroy():**
```java
unregisterReceiver(navigatorDataReceiver);
```

## Безопасность

### Защита от подделки данных

1. **Проверка package name:**
   ```java
   intent.setPackage("com.desaysv.tiggo.bridge");
   ```

2. **Проверка источника (опционально):**
   ```java
   String callerPackage = getCallingPackage();
   if (!"ru.yandex.yandexnavi".equals(callerPackage)) {
       // Отклонить
   }
   ```

## Тестирование

### Проверка потока данных

1. **Запустить навигатор**
2. **Построить маршрут**
3. **Начать навигацию**
4. **Проверить логи:**
   ```bash
   adb logcat | grep -E "(TiggoBridgeSender|BridgeService|NAVIGATION_DATA)"
   ```
5. **Проверить, что данные приходят в QNX**

## Следующие шаги

1. ✅ Создать `TiggoBridgeSender` в навигаторе
2. ✅ Добавить `BroadcastReceiver` в `BridgeService`
3. ✅ Реализовать преобразование данных
4. ⏳ Модифицировать APK навигатора
5. ⏳ Протестировать на реальном устройстве

