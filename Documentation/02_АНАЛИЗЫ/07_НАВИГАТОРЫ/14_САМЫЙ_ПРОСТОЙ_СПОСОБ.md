# Самый простой и эффективный способ получения данных навигации

## Вывод

**Самый простой и эффективный способ - это получить `NotificationDataManager` через `GuidanceProvider`, который можно получить через `GenericGuidanceComponent`.**

## План действий

### Шаг 1: Получить `GenericGuidanceComponent`

```java
// 1. Получить Context навигатора
Context naviContext = context.createPackageContext(
    "ru.yandex.yandexmaps", 
    Context.CONTEXT_INCLUDE_CODE | Context.CONTEXT_IGNORE_SECURITY
);
ClassLoader naviClassLoader = naviContext.getClassLoader();

// 2. Получить GenericGuidanceComponent
Class<?> componentClass = naviClassLoader.loadClass(
    "com.yandex.navikit.guidance.generic.GenericGuidanceComponent"
);
Field instanceField = componentClass.getField("INSTANCE");
Object component = instanceField.get(null);
```

### Шаг 2: Получить `GuidanceServicePresenter`

```java
// Получить GuidanceServicePresenter через getServicePresenter()
Method getServicePresenter = componentClass.getMethod("getServicePresenter$navikit_release");
Object servicePresenter = getServicePresenter.invoke(component);
```

### Шаг 3: Попробовать получить `GuidanceProvider` через `ServicePresenter`

```java
// Проверить, есть ли в ServicePresenter доступ к GuidanceProvider
// Или попробовать получить через другие методы
Method[] methods = servicePresenter.getClass().getDeclaredMethods();
for (Method method : methods) {
    if (method.getReturnType().getName().contains("GuidanceProvider") ||
        method.getReturnType().getName().contains("Guidance")) {
        Object result = method.invoke(servicePresenter);
        if (result != null) {
            // Это может быть Guidance или GuidanceProvider
        }
    }
}
```

### Шаг 4: Получить `NotificationDataManager` через `GuidanceProvider`

```java
// Если получили GuidanceProvider
Class<?> guidanceProviderClass = naviClassLoader.loadClass(
    "com.yandex.navikit.guidance.GuidanceProvider"
);
Method getNotificationDataManager = guidanceProviderClass.getMethod("notificationDataManager");
Object notificationDataManager = getNotificationDataManager.invoke(guidanceProvider);
```

### Шаг 5: Получить данные через `NotificationDataManager`

```java
// Получить NotificationData
Class<?> notificationDataManagerClass = naviClassLoader.loadClass(
    "com.yandex.navikit.guidance.NotificationDataManager"
);
Method getNotificationData = notificationDataManagerClass.getMethod("notificationData");
Object notificationData = getNotificationData.invoke(notificationDataManager);

// Получить данные
Class<?> notificationDataClass = naviClassLoader.loadClass(
    "com.yandex.navikit.notifications.NotificationData"
);
Method getTimeOfArrival = notificationDataClass.getMethod("getTimeOfArrival");
Method getDistanceLeft = notificationDataClass.getMethod("getDistanceLeft");
Method getTimeLeft = notificationDataClass.getMethod("getTimeLeft");
Method getTitle = notificationDataClass.getMethod("getTitle");
Method getSubtitle = notificationDataClass.getMethod("getSubtitle");

String timeOfArrival = (String) getTimeOfArrival.invoke(notificationData);
String distanceLeft = (String) getDistanceLeft.invoke(notificationData);
String timeLeft = (String) getTimeLeft.invoke(notificationData);
String title = (String) getTitle.invoke(notificationData);
String subtitle = (String) getSubtitle.invoke(notificationData);
```

## Альтернативный способ: Через `GenericGuidanceImpl`

Если `ServicePresenter` не дает доступ к `GuidanceProvider`, можно попробовать:

### Шаг 1: Получить `GenericGuidanceImpl`

```java
Method getGenericGuidance = componentClass.getMethod("getGenericGuidance");
Object genericGuidance = getGenericGuidance.invoke(component);
```

### Шаг 2: Зарегистрировать `GenericGuidanceConsumer`

```java
// Создать Consumer через Proxy
Class<?> consumerClass = naviClassLoader.loadClass(
    "com.yandex.navikit.guidance.generic.GenericGuidanceConsumer"
);
Object consumer = Proxy.newProxyInstance(
    naviClassLoader,
    new Class[]{consumerClass},
    new InvocationHandler() {
        @Override
        public Object invoke(Object proxy, Method method, Object[] args) {
            if (method.getName().equals("onHandlerReady")) {
                // Получили Handler, можно попробовать получить через него
                Object handler = args[0];
                // Попробовать найти Guidance через Handler
            }
            return null;
        }
    }
);

// Зарегистрировать Consumer
Method registerConsumer = genericGuidance.getClass().getMethod("registerConsumer", consumerClass);
registerConsumer.invoke(genericGuidance, consumer);
```

## Самый простой способ (рекомендуемый)

**Попробовать получить `NotificationDataManager` напрямую через статический метод или синглтон:**

```java
// Вариант 1: Через статический метод (если есть)
try {
    Class<?> notificationDataManagerClass = naviClassLoader.loadClass(
        "com.yandex.navikit.guidance.NotificationDataManager"
    );
    Method getInstance = notificationDataManagerClass.getMethod("getInstance");
    Object notificationDataManager = getInstance.invoke(null);
} catch (NoSuchMethodException e) {
    // Метод не найден, пробуем другой способ
}

// Вариант 2: Через поле INSTANCE (если есть)
try {
    Field instanceField = notificationDataManagerClass.getField("INSTANCE");
    Object notificationDataManager = instanceField.get(null);
} catch (NoSuchFieldException e) {
    // Поле не найдено, пробуем другой способ
}
```

## Рекомендация

**Начать с самого простого способа:**
1. Получить `GenericGuidanceComponent.INSTANCE`
2. Получить `GuidanceServicePresenter` через `getServicePresenter$navikit_release()`
3. Попробовать найти `GuidanceProvider` или `Guidance` через методы `ServicePresenter`
4. Получить `NotificationDataManager` через `GuidanceProvider.notificationDataManager()`
5. Получить данные через `NotificationDataManager.notificationData()`

**Если не получится:**
- Попробовать зарегистрировать `GenericGuidanceConsumer` и получить доступ через `Handler`
- Попробовать найти `NotificationDataManager` как синглтон
- Попробовать получить через другие компоненты

## Преимущества этого подхода

1. ✅ **Простота** - минимум шагов
2. ✅ **Эффективность** - прямой доступ к данным
3. ✅ **Надежность** - использует официальные интерфейсы
4. ✅ **Стабильность** - `NotificationDataManager` - это публичный интерфейс

## Недостатки

1. ⚠️ **Требует Reflection** - неофициальный способ
2. ⚠️ **Может измениться** - внутренние API могут измениться
3. ⚠️ **Требует запущенного навигатора** - данные доступны только когда навигация активна

## Следующие шаги

1. ⏳ Реализовать получение `NotificationDataManager` через `GenericGuidanceComponent`
2. ⏳ Протестировать на реальном устройстве
3. ⏳ Добавить обработку ошибок
4. ⏳ Добавить подписку на изменения через `NotificationDataManagerListener`

