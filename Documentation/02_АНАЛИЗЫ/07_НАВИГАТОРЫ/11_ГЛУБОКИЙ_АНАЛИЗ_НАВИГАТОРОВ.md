# Глубокий анализ навигаторов: Яндекс Навигатор и 2ГИС

## Цель анализа

Определить, какие данные можно извлечь из каждого навигатора и где их можно перехватить для передачи в систему QNX.

## 1. Яндекс Навигатор (ru.yandex.yandexmaps)

### Архитектура API

Яндекс Навигатор использует **Navikit SDK** с четкой архитектурой:

```
GenericGuidanceComponent (Singleton)
    ↓ getGenericGuidance()
GenericGuidance (Interface)
    ↓ реализуется
GenericGuidanceImpl
    ↓ содержит
Guidance (Interface) - основной интерфейс навигации
```

### Ключевые классы

#### 1. GenericGuidanceComponent

**Расположение:** `com.yandex.navikit.guidance.generic.GenericGuidanceComponent`

**Способ получения:**

```java
GenericGuidanceComponent.INSTANCE.getGenericGuidance()
```

**Статус:** ✅ Найден в декомпилированном коде, доступен через Reflection

#### 2. Guidance (Interface)

**Расположение:** `com.yandex.navikit.guidance.Guidance`

**Основные методы:**

```java
// Получение данных навигации
NextManeuver getNextManeuver();
DrivingRoute route();
PolylinePosition getRoutePosition();
ClassifiedLocation getLocation();
Double getNextLaneSignDistance();

// Управление навигацией
void start(DrivingRoute route);
void stop();
void resume();
void suspend();

// Слушатели
void addGuidanceListener(GuidanceListener listener);
void removeGuidanceListener(GuidanceListener listener);
```

**Статус:** ✅ Интерфейс найден, но получение экземпляра через Reflection проблематично

#### 3. GuidanceListener (Interface)

**Расположение:** `com.yandex.navikit.guidance.GuidanceListener`

**События:**

```java
void onLocationUpdated();
void onRoutePositionUpdated();
void onRouteChanged();
void onFinishedRoute();
void onStandingStatusUpdated();
void onFasterAlternativeUpdated();
void onJamForecastUpdated();
```

**Статус:** ✅ Можно зарегистрировать через Reflection

#### 4. NotificationDataManager

**Расположение:** `com.yandex.navikit.guidance.NotificationDataManager`

**Способ получения:**

```java
Guidance guidance = ...;
NotificationDataManager manager = guidance.notificationDataManager();
NotificationData data = manager.notificationData();
```

**Статус:** ✅ Альтернативный способ получения данных

#### 5. NotificationData (Class)

**Расположение:** `com.yandex.navikit.notifications.NotificationData`

**Данные:**

- `getTimeOfArrival()` - время прибытия
- `getDistanceLeft()` - оставшееся расстояние
- `getTimeLeft()` - оставшееся время
- И другие данные для уведомлений

**Статус:** ✅ Класс найден, содержит данные навигации

### Проблемы с Reflection подходом

**Что не работает:**

1. ❌ `GenericGuidanceImpl.handler` и `GenericGuidanceImpl.consumer` равны `null`
2. ❌ Не удается получить `Guidance` из `GenericGuidance`
3. ❌ Поля `handler` и `consumer` не инициализированы извне

**Причина:** Внутренние компоненты навигатора инициализируются только внутри приложения навигатора, недоступны извне.

### Альтернативные способы получения данных

#### Способ 1: NotificationDataManager

**Преимущества:**

- ✅ Доступен через `Guidance.notificationDataManager()`
- ✅ Содержит основные данные навигации
- ✅ Можно подписаться через `NotificationDataManagerListener`

**Недостатки:**

- ⚠️ Требует получения `Guidance` экземпляра
- ⚠️ Данные могут быть неполными

**Реализация:**

```java
// Через Reflection
Object guidance = getGuidanceInstance(context);
Method getNotificationDataManager = guidance.getClass().getMethod("notificationDataManager");
Object manager = getNotificationDataManager.invoke(guidance);

Method getNotificationData = manager.getClass().getMethod("notificationData");
Object data = getNotificationData.invoke(manager);

// Получение данных
Method getTimeOfArrival = data.getClass().getMethod("getTimeOfArrival");
String timeOfArrival = (String) getTimeOfArrival.invoke(data);
```

#### Способ 2: AccessibilityService

**Статус:** ❌ Недоступен в автомобильной системе (нет настроек Android)

#### Способ 3: BroadcastReceiver

**Поиск broadcast'ов:**

- ✅ Найдены внутренние broadcast'ы для UI
- ❌ Нет публичных broadcast'ов с данными навигации

#### Способ 4: ContentProvider

**Поиск:**

- ❌ Нет публичных ContentProvider'ов с данными навигации

#### Способ 5: SharedPreferences

**Поиск:**

- ⚠️ Найдены SharedPreferences, но нет явных ключей для навигационных данных
- ⚠️ Данные могут быть зашифрованы или в бинарном формате

#### Способ 6: File Monitoring

**Возможные пути:**

- `/data/data/ru.yandex.yandexmaps/`
- `/data/data/ru.yandex.yandexmaps/cache/`
- `/data/data/ru.yandex.yandexmaps/files/`

**Статус:** ⏳ Требует дополнительного исследования

### Рекомендации для Яндекс Навигатора

1. **Продолжить попытки через Reflection:**

   - Изучить `GenericGuidanceImpl` более детально
   - Найти способ получения `Guidance` через другие компоненты
   - Попробовать получить через `NotificationDataManager`

2. **Исследовать NotificationData:**

   - Проверить, какие данные доступны
   - Попробовать получить через Reflection

3. **Проверить файловую систему:**

   - Мониторить файлы навигатора
   - Искать JSON/XML файлы с данными

4. **Альтернатива:**
   - Если Reflection не работает, рассмотреть 2ГИС

---

## 2. 2ГИС (ru.dublgis.dgismobile)

### Архитектура

2ГИС использует **нативный код (JNI/C++)** для основной функциональности:

```
Java Layer (Android)
    ↓ JNI
Native Layer (C++/QSDK)
    ↓
Навигационный движок
```

### Ключевые классы

#### 1. GrymMobileApplication

**Расположение:** `ru.dublgis.dgismobile.GrymMobileApplication`

**Роль:** Главный Application класс

**Статус:** ✅ Найден, но не содержит навигационных API

#### 2. QSDK (Native SDK)

**Расположение:** `ru.dublgis.qsdk.*`

**Классы:**

- `V4options` - опции приложения
- `GrymTrace` - трассировка
- `LogElapsed` - логирование
- `ProcessInfo` - информация о процессе

**Статус:** ✅ Найдены, но это вспомогательные классы, не навигационные API

#### 3. Location Providers

**Расположение:** `ru.dublgis.androidlocation.*`

**Классы:**

- `GmsLocationProvider` - провайдер GPS
- `PassiveLocationProvider` - пассивный провайдер
- `NmeaListener` - слушатель NMEA

**Статус:** ✅ Найдены, но это только GPS, не навигационные данные

### Проблемы с 2ГИС

**Основная проблема:**

- ❌ Нет публичного Java API для навигации
- ❌ Вся логика навигации в нативном коде (JNI)
- ❌ Нет классов типа `Guidance`, `Route`, `Maneuver` в Java

**Следствия:**

- Невозможно использовать Reflection для получения данных
- Нет интерфейсов для подписки на события
- Нет публичных методов для получения данных

### Возможные способы получения данных из 2ГИС

#### Способ 1: BroadcastReceiver

**Поиск:**

- ⚠️ Найдены только системные broadcast'ы (TIME_SET, TIMEZONE_CHANGED)
- ❌ Нет публичных broadcast'ов с данными навигации

#### Способ 2: ContentProvider

**Поиск:**

- ❌ Нет публичных ContentProvider'ов

#### Способ 3: SharedPreferences

**Возможные ключи:**

- `ru.dublgis.qsdk.APP_OPTIONS` - опции приложения
- Другие ключи могут быть в нативном коде

**Статус:** ⏳ Требует дополнительного исследования

#### Способ 4: File Monitoring

**Возможные пути:**

- `/data/data/ru.dublgis.dgismobile/`
- `/data/data/ru.dublgis.dgismobile/cache/`
- `/data/data/ru.dublgis.dgismobile/files/`

**Статус:** ⏳ Требует дополнительного исследования

#### Способ 5: JNI Hooks

**Идея:** Перехватывать вызовы JNI методов

**Проблемы:**

- ⚠️ Требует root или Xposed Framework
- ⚠️ Сложная реализация
- ⚠️ Может нарушить работу навигатора

**Статус:** ❌ Не рекомендуется

### Рекомендации для 2ГИС

1. **Исследовать файловую систему:**

   - Мониторить файлы 2ГИС
   - Искать JSON/XML/бинарные файлы с данными

2. **Проверить SharedPreferences:**

   - Найти все ключи
   - Проверить, есть ли навигационные данные

3. **Альтернатива:**
   - Если нет способов получения данных, вернуться к Яндекс Навигатору

---

## Сравнение навигаторов

| Критерий                 | Яндекс Навигатор        | 2ГИС                         |
| ------------------------ | ----------------------- | ---------------------------- |
| **Java API**             | ✅ Есть (Navikit SDK)   | ❌ Нет (только нативный код) |
| **Reflection**           | ⚠️ Частично работает    | ❌ Не работает               |
| **Broadcast'ы**          | ⚠️ Только внутренние    | ❌ Нет публичных             |
| **ContentProvider**      | ❌ Нет публичных        | ❌ Нет публичных             |
| **SharedPreferences**    | ⚠️ Возможно             | ⚠️ Возможно                  |
| **File Monitoring**      | ⏳ Требует исследования | ⏳ Требует исследования      |
| **NotificationData**     | ✅ Есть                 | ❌ Нет                       |
| **Сложность интеграции** | Средняя                 | Высокая                      |

## Выводы и рекомендации

### Для Яндекс Навигатора:

1. **Продолжить исследования:**

   - Детально изучить `NotificationData` и `NotificationDataManager`
   - Попробовать получить данные через Reflection более аккуратно
   - Исследовать файловую систему

2. **Альтернативные подходы:**
   - Мониторинг файлов навигатора
   - Перехват через AccessibilityService (если станет доступен)
   - Использование NotificationDataManager

### Для 2ГИС:

1. **Основной фокус:**

   - Исследовать файловую систему
   - Проверить SharedPreferences
   - Поискать другие способы получения данных

2. **Если не работает:**
   - Вернуться к Яндекс Навигатору
   - Рассмотреть другие навигаторы

## Следующие шаги

1. ✅ **Завершено:** Анализ декомпилированного кода обоих навигаторов
2. ⏳ **В процессе:** Исследование NotificationDataManager в Яндекс Навигаторе
3. ⏳ **Запланировано:** Мониторинг файловой системы обоих навигаторов
4. ⏳ **Запланировано:** Проверка SharedPreferences
5. ⏳ **Запланировано:** Тестирование на реальном устройстве

## Рекомендация

**Начать с Яндекс Навигатора:**

- Есть Java API (хотя и сложный для доступа)
- Есть `NotificationDataManager` как альтернатива
- Больше возможностей для Reflection
- **Есть официальная документация** (см. [Документация Яндекс API](12_ДОКУМЕНТАЦИЯ_ЯНДЕКС_API.md))

**Если не получится:**

- Переключиться на исследование файловой системы
- Изучить официальную документацию более детально
