# Анализ Яндекс Навигатора

## Статус декомпиляции
✅ **Завершена** - 27633 Java файла декомпилировано

## Ключевые классы для извлечения навигационных данных

### 1. Guidance (Основной интерфейс навигации)
**Путь:** `com.yandex.mapkit.directions.navigation.Guidance`

**Методы:**
- `getCurrentRoute()` - получить текущий маршрут (`DrivingRoute`)
- `getLocation()` - получить текущее местоположение
- `getRoadName()` - получить название текущей дороги
- `getRouteStatus()` - получить статус маршрута
- `getWindshield()` - получить объект `Windshield` для маневров
- `addListener(GuidanceListener)` - добавить слушатель изменений

**Слушатель:** `GuidanceListener`
- `onLocationChanged()` - изменение местоположения
- `onCurrentRouteChanged()` - изменение маршрута
- `onRouteFinished()` - завершение маршрута
- `onRouteLost()` - потеря маршрута
- `onRoadNameChanged()` - изменение названия дороги

### 2. Windshield (Информация о предстоящих маневрах)
**Путь:** `com.yandex.mapkit.directions.navigation.Windshield`

**Методы:**
- `getManoeuvres()` - получить список предстоящих маневров (`List<UpcomingManoeuvre>`)
- `getDirectionSigns()` - получить знаки направления
- `getLaneSigns()` - получить знаки полос
- `getRoadEvents()` - получить дорожные события
- `addListener(WindshieldListener)` - добавить слушатель

**Слушатель:** `WindshieldListener`
- `onManoeuvresChanged()` - изменение маневров
- `onDirectionSignChanged()` - изменение знаков направления
- `onLaneSignChanged()` - изменение знаков полос
- `onRoadEventsChanged()` - изменение дорожных событий

### 3. UpcomingManoeuvre (Информация о маневре)
**Путь:** `com.yandex.mapkit.directions.navigation.UpcomingManoeuvre`

**Методы:**
- `getAnnotation()` - получить аннотацию маневра (`Annotation`)
- `getPosition()` - получить позицию маневра на маршруте (`RoutePosition`)

### 4. Annotation (Аннотация маневра)
**Путь:** `com.yandex.mapkit.directions.driving.Annotation`

**Методы:**
- `getAction()` - получить тип маневра (`Action`)
- `getActionMetadata()` - получить метаданные маневра
- `getDescriptionText()` - получить текстовое описание
- `getToponym()` - получить топоним
- `getLandmarks()` - получить ориентиры

### 5. Action (Тип маневра)
**Путь:** `com.yandex.mapkit.directions.driving.Action`

**Типы маневров (enum):**
- `UNKNOWN` - неизвестно
- `STRAIGHT` - прямо
- `SLIGHT_LEFT` - слегка налево
- `SLIGHT_RIGHT` - слегка направо
- `LEFT` - налево
- `RIGHT` - направо
- `HARD_LEFT` - резко налево
- `HARD_RIGHT` - резко направо
- `FORK_LEFT` - развилка налево
- `FORK_RIGHT` - развилка направо
- `UTURN_LEFT` - разворот налево
- `UTURN_RIGHT` - разворот направо
- `ENTER_ROUNDABOUT` - въезд на кольцо
- `LEAVE_ROUNDABOUT` - съезд с кольца
- `BOARD_FERRY` - посадка на паром
- `LEAVE_FERRY` - высадка с парома
- `EXIT_LEFT` - съезд налево
- `EXIT_RIGHT` - съезд направо
- `FINISH` - прибытие
- `WAYPOINT` - промежуточная точка

### 6. RoutePosition (Позиция на маршруте)
**Путь:** `com.yandex.mapkit.navigation.RoutePosition`

**Методы:**
- `distanceTo(RoutePosition)` - расстояние до другой позиции
- `distanceToFinish()` - расстояние до конца маршрута
- `timeToFinish()` - время до конца маршрута
- `getPoint()` - получить точку на карте
- `heading()` - получить направление
- `positionOnRoute(String)` - получить позицию на конкретном маршруте

### 7. DrivingRoute (Маршрут)
**Путь:** `com.yandex.mapkit.directions.driving.DrivingRoute`

**Методы:**
- `getGeometry()` - получить геометрию маршрута (`Polyline`)
- `getMetadata()` - получить метаданные маршрута
- `getPosition()` - получить текущую позицию на маршруте
- `getRoutePosition()` - получить позицию маршрута
- `getSections()` - получить секции маршрута
- `getWayPoints()` - получить точки маршрута

## Стратегия извлечения данных

### Вариант 1: Прямое использование API (предпочтительно)
1. **Получить экземпляр Guidance:**
   - Через `NavigationManager` или через рефлексию
   - Или через публичный API, если доступен

2. **Подписаться на события:**
   ```java
   Guidance guidance = getGuidanceInstance();
   guidance.addListener(new GuidanceListener() {
       @Override
       public void onLocationChanged() {
           // Обновить данные
       }
       
       @Override
       public void onCurrentRouteChanged(RouteChangeReason reason) {
           // Обновить маршрут
       }
   });
   
   Windshield windshield = guidance.getWindshield();
   windshield.addListener(new WindshieldListener() {
       @Override
       public void onManoeuvresChanged() {
           List<UpcomingManoeuvre> manoeuvres = windshield.getManoeuvres();
           if (!manoeuvres.isEmpty()) {
               UpcomingManoeuvre nextManoeuvre = manoeuvres.get(0);
               Annotation annotation = nextManoeuvre.getAnnotation();
               RoutePosition maneuverPosition = nextManoeuvre.getPosition();
               
               // Получить тип маневра
               Action action = annotation.getAction();
               
               // Получить текущую позицию
               RoutePosition currentPosition = guidance.getCurrentRoute().getRoutePosition();
               
               // Вычислить расстояние до маневра
               Double distanceToManeuver = currentPosition.distanceTo(maneuverPosition);
               
               // Получить оставшееся расстояние
               double remainingDistance = currentPosition.distanceToFinish();
               
               // Получить оставшееся время
               double remainingTime = currentPosition.timeToFinish();
               
               // Извлечь данные о маневре
           }
       }
   });
   ```

3. **Извлечь данные:**
   - Текущий маневр: первый элемент из `windshield.getManoeuvres()`
   - Тип маневра: через `annotation`
   - Расстояние до маневра: вычислить через `RoutePosition` и текущую позицию
   - Текущая дорога: `guidance.getRoadName()`
   - Маршрут: `guidance.getCurrentRoute()`

### Вариант 2: Accessibility Service (резервный)
Если прямой доступ к API недоступен, использовать Accessibility Service для чтения UI элементов Яндекс Навигатора.

### Вариант 3: MediaProjection (для отрисовки карты)
Использовать MediaProjection API для захвата экрана и извлечения визуальной информации о карте.

## Проблемы и решения

### Проблема 1: Получение экземпляра Guidance
**Решение:**
- Использовать рефлексию для доступа к внутренним компонентам
- Или найти публичный API для получения экземпляра
- Или использовать Broadcast Intents, если Яндекс Навигатор их отправляет

### Проблема 2: Вычисление расстояния до маневра
**Решение:**
- Использовать `RoutePosition.distanceTo()` для вычисления расстояния между текущей позицией и позицией маневра
- Получить текущую позицию через `Guidance.getCurrentRoute().getRoutePosition()`
- Получить позицию маневра через `UpcomingManoeuvre.getPosition()`

### Проблема 3: Тип маневра
**Решение:**
- Использовать `Annotation.getAction()` для получения типа маневра (`Action` enum)
- Сопоставить `Action` enum с типами маневров TurboDog (коды поворотов)
- Маппинг:
  - `LEFT` → код поворота налево
  - `RIGHT` → код поворота направо
  - `STRAIGHT` → код "прямо"
  - `UTURN_LEFT` / `UTURN_RIGHT` → код разворота
  - и т.д.

### 8. Ограничение скорости
**Путь:** `com.yandex.mapkit.directions.navigation.Guidance`

**Методы:**
- `getSpeedLimit()` - получить ограничение скорости (`LocalizedValue`)
- `getSpeedLimitStatus()` - получить статус ограничения скорости (`SpeedLimitStatus`)
- `getSpeedLimitTolerance()` - получить допуск превышения скорости
- `getSpeedLimitsPolicy()` - получить политику ограничений скорости

**Слушатель:** `GuidanceListener`
- `onSpeedLimitUpdated()` - обновление ограничения скорости
- `onSpeedLimitStatusUpdated()` - обновление статуса ограничения скорости

**Использование:**
```java
Guidance guidance = getGuidanceInstance();
LocalizedValue speedLimit = guidance.getSpeedLimit();
int speedLimitValue = speedLimit.getValue(); // значение в км/ч
String unit = speedLimit.getUnit(); // единица измерения

guidance.addListener(new GuidanceListener() {
    @Override
    public void onSpeedLimitUpdated() {
        LocalizedValue speedLimit = guidance.getSpeedLimit();
        // Отправить в систему для отображения на приборной панели
    }
    
    @Override
    public void onSpeedLimitStatusUpdated() {
        SpeedLimitStatus status = guidance.getSpeedLimitStatus();
        // Обновить статус ограничения скорости
    }
});
```

## Следующие шаги

1. ✅ Декомпиляция завершена
2. ✅ Изучена структура `Annotation` для понимания типов маневров
3. ✅ Изучен `RoutePosition` для вычисления расстояний
4. ✅ Найдены методы получения ограничения скорости
5. ⏳ Изучить, как получить экземпляр `Guidance` в рантайме
6. ⏳ Изучить механизм отправки данных на приборную панель (SVMapService)
7. ⏳ Изучить механизм отправки ограничения скорости (SVMeterInteraction)
8. ⏳ Создать прототип `DataExtractor` для извлечения данных
9. ⏳ Протестировать извлечение данных на реальном устройстве

## Сравнение с TurboDog

### TurboDog отправляет через Broadcast:
- `turbodog.navigation.system.message`
- Параметры:
  - `TURN_TYPE` - тип поворота
  - `TURN_DIST` - расстояние до поворота
  - `REMAINING_DIST` - оставшееся расстояние
  - `REMAINING_TIME` - оставшееся время
  - `CURRENT_ROAD` - текущая дорога
  - `NEXT_ROAD` - следующая дорога

### Яндекс Навигатор предоставляет через API:
- `Windshield.getManoeuvres()` - маневры
- `Guidance.getRoadName()` - текущая дорога
- `Guidance.getCurrentRoute()` - маршрут
- `Guidance.getLocation()` - местоположение

**Задача:** Преобразовать данные Яндекс Навигатора в формат TurboDog для отправки на приборную панель.

