# Анализ приложений настроек системы и автомобиля

## Обзор

Декомпилированы и проанализированы два ключевых системных приложения:
- **SVVehicleSetting** (`com.desaysv.vehiclesetting`) - настройки системы и автомобиля
- **SVHvac** (`com.desaysv.svhvac`) - управление климат-контролем

## SVVehicleSetting - Настройки системы

### Основные компоненты

#### 1. SmartDriveSettingFragment
**Путь:** `com.desaysv.vehiclesetting.ui.fragment.SmartDriveSettingFragment`

**Ключевые элементы:**
- `svSpeedLimit` (SettingSwitchView) - переключатель ограничения скорости
- `saOverSpeedAlarm` (SettingActionView) - настройка предупреждения о превышении скорости
- `svIntelligentSpeedControl` (SettingSwitchView) - интеллектуальный контроль скорости

**Методы:**
- `setSpeedLimit(boolean z, boolean z2)` - установка ограничения скорости
- `setOverSpeedAlarm(int i)` - установка порога предупреждения о превышении скорости
- `setIntelligentSpeedControl(boolean z)` - включение/выключение интеллектуального контроля скорости

#### 2. OverSpeedAlarmFragment
**Путь:** `com.desaysv.vehiclesetting.ui.fragment.OverSpeedAlarmFragment`

**Назначение:** Фрагмент для настройки порога предупреждения о превышении скорости

**Диапазоны:**
- КМ/Ч: 30-170 км/ч (шаг 5)
- МИЛЬ/Ч: 20-80 миль/ч (шаг 5)

**Команда:** CMD_ID = {13} - используется для получения/отправки значения порога

#### 3. SmartDrivePresenter
**Путь:** `com.desaysv.vehiclesetting.presenter.SmartDrivePresenter`

**Ключевые методы:**

```java
// Отправка значения ограничения скорости
public void sendSpeedLimitValue(boolean z) {
    getModel().sendAndResponseCarSetting(64, 32, z ? 1 : 0);
    DataServiceMgr.getInstance().addDesayEventData("CarSet.IntelligentDrive.ISLCSet", "ISLCSetflg", "ISLCSet", z ? "开" : "关");
}

// Отправка значения интеллектуального контроля скорости
public void sendIntelligentSpeedControlValue(boolean z) {
    getModel().sendAndResponseCarSetting(109, 109, z ? 1 : 2);
    DataServiceMgr.getInstance().addDesayEventData("CarSet.IntelligentDrive.ISCSet", "ISCSetflg", "ISCSet", z ? "开" : "关");
}
```

**Параметры sendAndResponseCarSetting:**
- Первый параметр (64, 109) - ID команды для отправки
- Второй параметр (32, 109) - cmdId для получения ответа
- Третий параметр - значение (1 = включено, 0/2 = выключено)

#### 4. CarInfoModel
**Путь:** `com.desaysv.vehiclesetting.model.CarInfoModel`

**Механизм работы:**
- Использует `CarInfoProxy` из библиотеки `com.desaysv.libsvcarinfo`
- Использует `CarInfoHelper` для прослушивания изменений
- Отправка через `CarInfoProxy.sendItemValue(moduleId, cmdId, value)`

**Методы отправки:**
```java
// Отправка с ожиданием ответа
public void sendAndResponseCarSetting(int cmdId, int responseCmdId, int value) {
    sendAndResponse(0, cmdId, responseCmdId, value, 10);
}

// Прямая отправка
public void sendCarSettingValue(int cmdId, int value) {
    this.mCarInfoProxy.sendItemValue(0, cmdId, value);
}
```

#### 5. CarSpeedUtil
**Путь:** `com.desaysv.vehiclesetting.util.CarSpeedUtil`

**Назначение:** Получение текущей скорости автомобиля

**Механизм:**
- Использует Android Car API (`android.car.Car`)
- Подключается к `CarSensorManager`
- Слушает события датчика скорости (ID: 291504647)
- Конвертирует скорость из м/с в км/ч (умножение на 3.6)

**Метод:**
```java
public int getSpeed() {
    return (int) this.currentSpeed; // в км/ч
}
```

### Ключевые команды (cmdId)

| cmdId | Назначение | Значения |
|-------|-----------|----------|
| 13 | Предупреждение о превышении скорости | 0-8 (порог: 30-170 км/ч с шагом 5) |
| 32 | Ограничение скорости (включено/выключено) | 0 = выкл, 1 = вкл, 2 = выкл |
| 64 | ID команды для отправки ограничения скорости | - |
| 109 | Интеллектуальный контроль скорости | 1 = вкл, 2 = выкл |

### Важные выводы

1. **Ограничение скорости НЕ является числовым значением** - это просто включение/выключение функции
2. **Порог предупреждения** (OverSpeedAlarm) - это отдельная настройка, которая задает значение в км/ч
3. **Механизм отправки:** Все команды отправляются через `CarInfoProxy`, который, вероятно, взаимодействует с CAN-шиной или системным сервисом
4. **Отображение на приборной панели:** Значение ограничения скорости, вероятно, берется из другого источника (например, из навигации или распознавания дорожных знаков)

## SVHvac - Климат-контроль

### Структура

**Манифест:**
- Package: `com.desaysv.svhvac`
- Main Application: `com.desaysv.svhvac.application.HvacApplication`
- Service: `com.desaysv.svhvac.service.HvacService`
- Receiver: `com.desaysv.svhvac.receiver.BootCompleteReceiver`

**Примечание:** Декомпиляция SVHvac показала только файл `R.java`. Это может означать:
1. Приложение использует нативные библиотеки
2. Код обфусцирован
3. Основная логика находится в сервисе, который не был полностью декомпилирован

### Запуск при загрузке

Приложение запускается при загрузке системы через `BootCompleteReceiver` с приоритетом 101.

## Механизм работы с ограничением скорости

### Текущая реализация

1. **Пользователь включает ограничение скорости** в настройках
2. **SmartDrivePresenter.sendSpeedLimitValue(true)** вызывается
3. **CarInfoModel.sendAndResponseCarSetting(64, 32, 1)** отправляет команду
4. **CarInfoProxy.sendItemValue(0, 64, 1)** отправляет значение в систему
5. **Система обрабатывает команду** и, вероятно, отправляет данные на приборную панель через CAN-шину

### Как интегрировать ограничение скорости из Яндекс Навигатора

#### Вариант 1: Подмена значения через CarInfoProxy

**Проблема:** Неизвестно, как именно ограничение скорости отображается на приборной панели. Возможно, оно берется из:
- Распознавания дорожных знаков (TSR - Traffic Sign Recognition, cmdId 105)
- Навигационной системы
- Ручной настройки пользователя

#### Вариант 2: Использование TSR (Traffic Sign Recognition)

В коде есть упоминание `sendTrafficSignRecognitionValue(boolean z)` с cmdId 105. Возможно, система распознавания дорожных знаков может обновлять ограничение скорости.

#### Вариант 3: Прямая отправка через Broadcast Intent

Нужно найти, какой Broadcast Intent или System Property используется для отправки ограничения скорости на приборную панель.

## Следующие шаги

1. **Изучить библиотеку `com.desaysv.libsvcarinfo`** - найти, как она взаимодействует с системой
2. **Найти механизм отображения ограничения скорости на приборной панели** - возможно, через Broadcast Intent или System Property
3. **Изучить SVMeterInteraction** - приложение, которое взаимодействует с приборной панелью
4. **Проверить, как TurboDog отправляет ограничение скорости** - возможно, через тот же механизм, что и навигационные данные

## SVHvac - Дополнительная информация

### Структура декомпиляции

SVHvac был успешно декомпилирован, однако в папке `sources` находится только файл `R.java`. Это означает:
- Основной код может быть обфусцирован
- Логика может находиться в нативных библиотеках (.so файлы)
- Или код находится в сервисе `HvacService`, который не был полностью декомпилирован

### Ресурсы

Приложение содержит обширные ресурсы:
- Более 1300 PNG изображений (иконки, анимации климат-контроля)
- Множество XML файлов для layouts и drawables
- Строковые ресурсы на множестве языков

### Выводы по SVHvac

Для управления климат-контролем через Bridge Service потребуется:
1. Изучить Broadcast Intents, которые использует SVHvac
2. Найти способ отправки команд через CarInfoProxy (аналогично ограничению скорости)
3. Или использовать прямые Broadcast Intents, если они доступны

## Полезные ссылки в коде

- `CarInfoProxy.getInstance().getItemValue(moduleId, cmdId)` - получение значения
- `CarInfoProxy.getInstance().sendItemValue(moduleId, cmdId, value)` - отправка значения
- `CarInfoHelper` - прослушивание изменений значений
- `SystemUtil.getVehicleState(5)` - получение состояния автомобиля (ACC включен/выключен)

