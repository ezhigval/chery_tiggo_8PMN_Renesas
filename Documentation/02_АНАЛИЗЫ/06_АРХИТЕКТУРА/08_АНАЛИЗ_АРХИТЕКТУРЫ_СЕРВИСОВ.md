# Анализ архитектуры сервисов

**Дата:** 2024  
**Версия:** 1.0  
**Статус:** ✅ Завершено

---

## 📋 Оглавление

1. [Постановка задачи](#постановка-задачи)
2. [Анализ требований](#анализ-требований)
3. [Варианты архитектуры](#варианты-архитектуры)
4. [Сравнительный анализ](#сравнительный-анализ)
5. [Рекомендация](#рекомендация)
6. [Детальная архитектура](#детальная-архитектура)

---

## 🎯 Постановка задачи

**Вопрос:** Делаем ли мы один общий сервис для всех доработок или отдельные сервисы для каждой функции?

**Функции проекта:**
1. **Навигация** - интеграция Яндекс Навигатора
2. **Музыка** - интеграция Яндекс Музыки
3. **Голосовое управление** - интеграция Яндекс Алисы
4. **Кастомный лаунчер** - скрытие системных приложений
5. **Настройки** - интеграция с системными настройками

---

## 📊 Анализ требований

### 1. Навигация

**Компоненты:**
- `NavigationMonitor` - мониторинг Яндекс Навигатора
- `DataExtractor` - извлечение навигационных данных
- `MapRenderer` - отрисовка упрощенной карты
- `SystemSender` - отправка данных в систему

**Механизмы:**
- AccessibilityService для мониторинга UI
- Broadcast Intent для отправки данных
- MediaProjection API (опционально) для скриншотов

**Частота обновления:** Высокая (1 Гц и выше)

**Критичность:** Высокая (безопасность вождения)

---

### 2. Музыка

**Компоненты:**
- `MediaMonitor` - мониторинг Яндекс Музыки
- `MetadataExtractor` - извлечение метаданных трека
- `MediaSender` - отправка метаданных в систему

**Механизмы:**
- MediaSession API для получения метаданных
- Broadcast Intent для отправки метаданных
- Модификация SVMedia для отображения в списке источников

**Частота обновления:** Низкая (при смене трека)

**Критичность:** Низкая (не влияет на безопасность)

---

### 3. Голосовое управление

**Компоненты:**
- `VoiceAssistant` - интеграция Яндекс Алисы
- `CommandProcessor` - обработка голосовых команд
- `SystemController` - выполнение команд (окна, кондиционер и т.д.)

**Механизмы:**
- Интеграция с iFlytek SDK
- Broadcast Intent для отправки команд
- CarInfoProxy для управления функциями автомобиля

**Частота обновления:** По запросу пользователя

**Критичность:** Средняя (удобство использования)

---

### 4. Кастомный лаунчер

**Компоненты:**
- `LauncherActivity` - главный экран
- `AppFilter` - фильтрация системных приложений
- `AppLauncher` - запуск приложений

**Механизмы:**
- Стандартный Android Launcher API
- PackageManager для получения списка приложений
- ActivityOptions для запуска на разных дисплеях

**Частота обновления:** При запуске приложения

**Критичность:** Низкая (удобство использования)

---

### 5. Настройки

**Компоненты:**
- `SettingsMonitor` - мониторинг системных настроек
- `SettingsController` - управление настройками
- `SpeedLimitManager` - управление ограничением скорости

**Механизмы:**
- CarInfoProxy для отправки команд
- Broadcast Intent для получения событий
- System Properties (опционально)

**Частота обновления:** При изменении настроек

**Критичность:** Средняя (функциональность)

---

## 🏗️ Варианты архитектуры

### Вариант 1: Один общий сервис

```
┌─────────────────────────────────────────┐
│  TiggoIntegrationService                 │
│  (com.desaysv.tiggointegration)        │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  NavigationModule                 │ │
│  │  ├── NavigationMonitor            │ │
│  │  ├── DataExtractor                │ │
│  │  ├── MapRenderer                  │ │
│  │  └── NavigationSender             │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  MediaModule                       │ │
│  │  ├── MediaMonitor                  │ │
│  │  ├── MetadataExtractor             │ │
│  │  └── MediaSender                   │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  VoiceModule                       │ │
│  │  ├── VoiceAssistant                │ │
│  │  ├── CommandProcessor              │ │
│  │  └── SystemController               │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  SettingsModule                     │ │
│  │  ├── SettingsMonitor                │ │
│  │  ├── SettingsController             │ │
│  │  └── SpeedLimitManager               │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  CommonComponents                   │ │
│  │  ├── BroadcastManager               │ │
│  │  ├── SystemSender                   │ │
│  │  └── EventBus                        │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**Особенности:**
- Один Foreground Service
- Модульная структура внутри
- Общие компоненты для всех модулей
- Единая точка входа

---

### Вариант 2: Отдельные сервисы

```
┌─────────────────────────────────────────┐
│  NavigationBridgeService                │
│  (com.desaysv.navibridge)              │
│  ├── NavigationMonitor                  │
│  ├── DataExtractor                      │
│  ├── MapRenderer                        │
│  └── NavigationSender                   │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  MediaBridgeService                     │
│  (com.desaysv.mediabridge)              │
│  ├── MediaMonitor                       │
│  ├── MetadataExtractor                  │
│  └── MediaSender                        │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  VoiceAssistantService                  │
│  (com.desaysv.voiceassistant)           │
│  ├── VoiceAssistant                     │
│  ├── CommandProcessor                   │
│  └── SystemController                    │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  SettingsBridgeService                  │
│  (com.desaysv.settingsbridge)          │
│  ├── SettingsMonitor                    │
│  ├── SettingsController                 │
│  └── SpeedLimitManager                  │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  CustomLauncher                         │
│  (com.desaysv.customlauncher)           │
│  ├── LauncherActivity                  │
│  ├── AppFilter                          │
│  └── AppLauncher                        │
└─────────────────────────────────────────┘
```

**Особенности:**
- Отдельный Foreground Service для каждой функции
- Независимая разработка и обновление
- Изолированные компоненты
- Разные точки входа

---

## ⚖️ Сравнительный анализ

### Вариант 1: Один общий сервис

#### ✅ Преимущества

1. **Единая точка управления**
   - Один сервис для всех функций
   - Проще управлять жизненным циклом
   - Единая конфигурация

2. **Общие компоненты**
   - Переиспользование кода (BroadcastManager, SystemSender)
   - Меньше дублирования
   - Единая система логирования и мониторинга

3. **Эффективность ресурсов**
   - Один процесс вместо нескольких
   - Меньше потребление памяти
   - Меньше нагрузка на систему

4. **Простота установки**
   - Один APK для установки
   - Проще управление версиями
   - Меньше точек отказа

5. **Координация между модулями**
   - Легче обмениваться данными между модулями
   - Единая система событий
   - Синхронизация состояний

#### ❌ Недостатки

1. **Сложность разработки**
   - Большой монолитный проект
   - Сложнее разделение ответственности
   - Требуется тщательное планирование архитектуры

2. **Зависимости между модулями**
   - Изменения в одном модуле могут влиять на другие
   - Сложнее тестирование отдельных компонентов
   - Риск "хрупкой" архитектуры

3. **Обновления**
   - Обновление всего сервиса при изменении одной функции
   - Больше риск ошибок при обновлении
   - Сложнее откат изменений

4. **Отладка**
   - Сложнее изолировать проблемы
   - Больше логов для анализа
   - Сложнее профилирование

---

### Вариант 2: Отдельные сервисы

#### ✅ Преимущества

1. **Модульность**
   - Независимая разработка каждого сервиса
   - Четкое разделение ответственности
   - Легче понять и поддерживать

2. **Независимые обновления**
   - Обновление только нужного сервиса
   - Меньше риск ошибок
   - Проще откат изменений

3. **Изоляция**
   - Проблемы в одном сервисе не влияют на другие
   - Легче тестирование
   - Проще отладка

4. **Гибкость**
   - Можно отключить ненужные сервисы
   - Разные версии для разных функций
   - Легче экспериментировать

5. **Масштабируемость**
   - Легче добавлять новые функции
   - Не нужно пересобирать весь проект
   - Меньше конфликтов при разработке

#### ❌ Недостатки

1. **Дублирование кода**
   - Общие компоненты в каждом сервисе
   - Больше кода для поддержки
   - Риск рассинхронизации

2. **Потребление ресурсов**
   - Несколько процессов
   - Больше потребление памяти
   - Больше нагрузка на систему

3. **Сложность координации**
   - Сложнее обмениваться данными
   - Нужны дополнительные механизмы синхронизации
   - Риск конфликтов

4. **Установка и управление**
   - Несколько APK для установки
   - Сложнее управление версиями
   - Больше точек отказа

5. **Разрешения**
   - Каждый сервис требует свои разрешения
   - Сложнее управление разрешениями
   - Больше запросов пользователю

---

## 🎯 Рекомендация

### Рекомендуемый подход: **Один общий сервис с модульной архитектурой**

**Обоснование:**

1. **Общие компоненты**
   - Все функции используют Broadcast Intent для отправки данных
   - Все функции требуют мониторинга системных событий
   - Все функции взаимодействуют с системой автомобиля

2. **Эффективность**
   - Навигация требует высокой частоты обновления (1 Гц)
   - Общий сервис позволяет оптимизировать использование ресурсов
   - Меньше конкуренции за системные ресурсы

3. **Координация**
   - Навигация и музыка могут взаимодействовать (например, приглушение музыки при голосовых подсказках)
   - Голосовое управление должно координировать все функции
   - Настройки влияют на все функции

4. **Простота установки**
   - Один APK проще для пользователя
   - Меньше точек отказа при установке
   - Проще управление версиями

5. **Архитектура проекта**
   - Модульная структура внутри одного сервиса
   - Четкое разделение ответственности через модули
   - Легко добавлять новые модули

---

## 🏗️ Детальная архитектура

### Структура общего сервиса

```
TiggoIntegrationService/
├── core/                          # Общие компоненты
│   ├── BroadcastManager          # Управление Broadcast Intents
│   ├── SystemSender              # Отправка данных в систему
│   ├── EventBus                  # Система событий
│   ├── Logger                    # Логирование
│   └── ConfigManager             # Управление конфигурацией
│
├── navigation/                   # Модуль навигации
│   ├── NavigationMonitor         # Мониторинг Яндекс Навигатора
│   ├── DataExtractor             # Извлечение данных
│   ├── MapRenderer               # Отрисовка карты
│   └── NavigationSender          # Отправка навигационных данных
│
├── media/                        # Модуль медиа
│   ├── MediaMonitor              # Мониторинг Яндекс Музыки
│   ├── MetadataExtractor        # Извлечение метаданных
│   └── MediaSender               # Отправка метаданных
│
├── voice/                        # Модуль голосового управления
│   ├── VoiceAssistant            # Интеграция Яндекс Алисы
│   ├── CommandProcessor          # Обработка команд
│   └── SystemController           # Выполнение команд
│
├── settings/                     # Модуль настроек
│   ├── SettingsMonitor           # Мониторинг настроек
│   ├── SettingsController        # Управление настройками
│   └── SpeedLimitManager         # Управление ограничением скорости
│
└── launcher/                     # Модуль лаунчера
    ├── LauncherActivity          # Главный экран
    ├── AppFilter                 # Фильтрация приложений
    └── AppLauncher               # Запуск приложений
```

### Интерфейсы модулей

```java
// Базовый интерфейс для всех модулей
public interface IntegrationModule {
    void initialize(Context context);
    void start();
    void stop();
    void onSystemEvent(BroadcastIntent intent);
    boolean isEnabled();
    void setEnabled(boolean enabled);
}

// Пример реализации модуля навигации
public class NavigationModule implements IntegrationModule {
    private NavigationMonitor monitor;
    private DataExtractor extractor;
    private MapRenderer renderer;
    private NavigationSender sender;
    
    @Override
    public void initialize(Context context) {
        monitor = new NavigationMonitor(context);
        extractor = new DataExtractor();
        renderer = new MapRenderer();
        sender = new NavigationSender(context);
    }
    
    @Override
    public void start() {
        if (isEnabled()) {
            monitor.start();
        }
    }
    
    // ...
}
```

### Управление модулями

```java
public class TiggoIntegrationService extends Service {
    private Map<String, IntegrationModule> modules;
    private BroadcastManager broadcastManager;
    private EventBus eventBus;
    
    @Override
    public void onCreate() {
        super.onCreate();
        
        // Инициализация общих компонентов
        broadcastManager = new BroadcastManager(this);
        eventBus = new EventBus();
        
        // Инициализация модулей
        modules = new HashMap<>();
        modules.put("navigation", new NavigationModule());
        modules.put("media", new MediaModule());
        modules.put("voice", new VoiceModule());
        modules.put("settings", new SettingsModule());
        
        // Инициализация модулей
        for (IntegrationModule module : modules.values()) {
            module.initialize(this);
        }
    }
    
    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        // Запуск модулей
        for (IntegrationModule module : modules.values()) {
            if (module.isEnabled()) {
                module.start();
            }
        }
        
        return START_STICKY;
    }
}
```

---

## 📋 Выводы

1. **Рекомендуется один общий сервис** с модульной архитектурой
2. **Модули должны быть независимыми** внутри общего сервиса
3. **Общие компоненты** выносятся в core
4. **Каждый модуль** реализует единый интерфейс IntegrationModule
5. **Управление модулями** централизовано через главный сервис

---

## 🔗 Связанные документы

- [Техническое задание](../ТЕХНИЧЕСКОЕ_ЗАДАНИЕ.md)
- [Архитектура Bridge Service](07_АРХИТЕКТУРА_BRIDGE_SERVICE.md)
- [Анализ NS.apk](02_АНАЛИЗ_NS_APK.md)

---

**Дата:** 2024  
**Версия:** 1.0  
**Статус:** ✅ Завершено

