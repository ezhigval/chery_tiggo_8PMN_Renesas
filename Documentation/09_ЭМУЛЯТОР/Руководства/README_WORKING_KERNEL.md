# Использование рабочего ядра для тестирования приложений

## Зачем это нужно?

Оригинальное ядро из автомобиля может не запускаться в QEMU из-за проблем с инициализацией. Для быстрого тестирования модифицированных приложений можно использовать рабочее Android ядро.

**Важно:** Ваши оригинальные `system.img` и `vendor.img` будут использоваться - все ваши приложения, сервисы и настройки останутся без изменений!

## Быстрый старт

### 1. Получите рабочее Android ядро для ARM64

Варианты:

- **Готовое ядро из AOSP** (рекомендуется)
- **Ядро из другого Android устройства** с похожим SoC
- **Стандартное Linux ядро** с Android драйверами

### 2. Сохраните ядро

Сохраните ядро в одном из мест:

- `development/emulator/kernels/android_kernel_arm64`
- `~/.android/kernels/android_kernel_arm64`
- Или укажите путь через переменную окружения

### 3. Включите режим рабочего ядра

```bash
export T18FL3_USE_WORKING_KERNEL=1
export T18FL3_WORKING_KERNEL_PATH=/path/to/your/kernel  # Опционально
python3 main.py
```

Или отредактируйте `development/emulator/config/working_kernel_config.py`:

```python
WORKING_KERNEL_PATH = Path("/path/to/your/kernel")
```

### 4. Запустите эмулятор

Эмулятор автоматически:

- Использует стандартную `virt` машину QEMU (стабильная)
- Загружает ваше рабочее ядро
- Использует оригинальные `system.img` и `vendor.img`
- Все ваши приложения будут работать!

## Где взять рабочее ядро?

### Вариант 1: Скачать готовое (самый простой)

1. Найдите готовый Android образ для ARM64 (например, LineageOS)
2. Извлеките ядро из образа:
   ```bash
   # Если это boot.img
   python3 -c "
   import struct
   with open('boot.img', 'rb') as f:
       header = f.read(1632)
       page_size = struct.unpack('<I', header[36:40])[0]
       kernel_size = struct.unpack('<I', header[8:12])[0]
       f.seek(page_size)
       kernel = f.read(kernel_size)
       with open('kernel', 'wb') as k:
           k.write(kernel)
   "
   ```

### Вариант 2: Собрать из AOSP

```bash
# Клонируйте AOSP
repo init -u https://android.googlesource.com/platform/manifest -b android-13.0.0_r1
repo sync

# Соберите ядро
cd kernel/common
make ARCH=arm64 defconfig
make ARCH=arm64
# Результат: arch/arm64/boot/Image
```

### Вариант 3: Использовать стандартное Linux ядро

Можно использовать стандартное Linux ядро с добавленными Android драйверами:

```bash
# Скачайте исходники Linux
git clone https://github.com/torvalds/linux.git
cd linux

# Настройте конфигурацию
make ARCH=arm64 defconfig
# Включите Android опции в menuconfig
make ARCH=arm64 menuconfig
# Соберите
make ARCH=arm64
```

## Что работает в этом режиме?

✅ **Работает:**

- Все ваши приложения из `system.img`
- Все системные сервисы
- Все настройки и конфигурации
- ADB подключение
- VNC для графического интерфейса
- Тестирование модифицированных APK

❌ **Может не работать:**

- Низкоуровневые драйверы, специфичные для автомобиля
- Точные адреса памяти (но для приложений это не важно)
- Некоторые аппаратные функции

## Для тестирования приложений этого достаточно!

Приложения работают на уровне Android, а не ядра. Если Android запускается, приложения будут работать.

## Переключение между режимами

### Режим с рабочим ядром (быстрое тестирование):

```bash
export T18FL3_USE_WORKING_KERNEL=1
python3 main.py
```

### Режим с оригинальным ядром (максимальная точность):

```bash
unset T18FL3_USE_WORKING_KERNEL
python3 main.py
```

## Создание пакета обновления

После тестирования приложений:

1. Модифицируйте приложения в `system.img`
2. Создайте delta-обновление (только измененные файлы)
3. Создайте OTA пакет
4. Установите в реальный автомобиль

**Важно:** Пакет обновления будет использовать оригинальное ядро автомобиля, поэтому если вы тестировали на другом ядре, это не проблема - приложения работают на уровне Android.

## Устранение проблем

### Ядро не найдено

```
❌ No working kernel found! Please provide working_kernel_path
```

**Решение:** Убедитесь, что ядро находится в одном из стандартных мест или укажите путь через `T18FL3_WORKING_KERNEL_PATH`.

### Ядро не запускается

- Проверьте, что ядро скомпилировано для ARM64
- Убедитесь, что ядро не сжато (или распакуйте его)
- Попробуйте другое ядро

### Android не загружается

- Проверьте, что `system.img` и `vendor.img` корректны
- Убедитесь, что ramdisk из `boot.img` используется
- Проверьте логи QEMU

## Дополнительная информация

См. также:

- `development/docs/STRATEGY_TESTING.md` - стратегия тестирования
- `development/emulator/config/working_kernel_config.py` - конфигурация

