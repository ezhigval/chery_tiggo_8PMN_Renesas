# Архитектура кастомного эмулятора T18FL3

## Основные принципы (ТЗ)

### ⚠️ КРИТИЧЕСКИЕ ПРАВИЛА (НЕЛЬЗЯ НАРУШАТЬ)

1. **НЕ МЕНЯЕМ ОБРАЗЫ** - работаем с оригинальными образами как есть
2. **НЕ ПЕРЕДЕЛЫВАЕМ** - эмулятор должен запускать все компоненты
3. **ПОЛНОЕ ЛОГИРОВАНИЕ** - все процессы логируются в реальном времени
4. **ДВА ЭКРАНА** - два независимых дисплея 12.3" (один над другим)
5. **CAN-ШИНА** - полная симуляция для имитации автомобиля
6. **ВСЕ УРОВНИ** - доступ к разработке от GUI до машинного кода

## Архитектура

```
┌─────────────────────────────────────────────────────────┐
│                    T18FL3 Emulator GUI                   │
│  ┌──────────────────┐  ┌──────────────────┐            │
│  │  Display 1     │  │  Display 2        │            │
│  │  (12.3")       │  │  (12.3")          │            │
│  │  Instrument    │  │  Multimedia       │            │
│  └──────────────────┘  └──────────────────┘            │
│  ┌──────────────────────────────────────────┐          │
│  │  Log Viewer (Real-time)                  │          │
│  └──────────────────────────────────────────┘          │
│  ┌──────────────────────────────────────────┐          │
│  │  Control Panel (Start/Stop/Reset)         │          │
│  └──────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│              Emulator Core (Python/C++)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ QEMU Manager│  │ Log Manager  │  │ CAN Simulator │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ Image Manager│  │ Process      │  │ Device       │ │
│  │              │  │ Monitor      │  │ Emulator     │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                    QEMU Backend                          │
│  - ARM64 (Cortex-A57)                                   │
│  - Android 9 + QNX                                      │
│  - Все оригинальные образы                              │
│  - VirtIO устройства                                    │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│              Virtual Hardware Layer                      │
│  - CAN Bus (vcan)                                       │
│  - GPS (gpsd)                                           │
│  - Bluetooth (BlueZ)                                    │
│  - Dual Display (VNC/QEMU Display)                     │
└─────────────────────────────────────────────────────────┘
```

## Компоненты

### 1. GUI Layer (PyQt6/Qt6)

**Два экрана:**
- Display 1: Instrument Cluster (12.3")
- Display 2: Multimedia System (12.3")
- Размещение: один над другим с небольшим отступом
- Или: два отдельных окна

**Log Viewer:**
- Real-time логирование
- Фильтрация по уровням (DEBUG, INFO, WARN, ERROR)
- Поиск по логам
- Экспорт логов

**Control Panel:**
- Start/Stop/Reset эмулятора
- Настройки (CPU, Memory, etc.)
- Мониторинг ресурсов
- CAN-шина симулятор (отправка сообщений)

### 2. Emulator Core

**QEMU Manager:**
- Управление процессом QEMU
- Запуск с правильными параметрами
- Мониторинг состояния
- Перехват вывода

**Log Manager:**
- Централизованное логирование
- Запись в файлы
- Real-time вывод в GUI
- Уровни логирования

**CAN Simulator:**
- Виртуальный CAN интерфейс (vcan)
- Генерация CAN сообщений
- Имитация автомобильных систем
- Запись/воспроизведение CAN трафика

**Image Manager:**
- Проверка целостности образов
- Монтирование ext2 образов
- Управление образами без изменений

**Process Monitor:**
- Мониторинг всех процессов QEMU
- CPU/Memory использование
- Сетевая активность
- I/O статистика

**Device Emulator:**
- GPS эмуляция
- Bluetooth эмуляция
- Камеры (круговой обзор)
- Датчики

### 3. QEMU Backend

**Конфигурация:**
- Machine: virt,highmem=on
- CPU: cortex-a57
- Memory: 4GB
- SMP: 4 cores
- Все оригинальные образы (format=raw)

**Два дисплея:**
- Display 1: VNC порт 5900
- Display 2: VNC порт 5901
- Или: два QEMU display backend

**Сеть:**
- User networking
- ADB порт: 5555
- Проброс портов

### 4. Virtual Hardware

**CAN Bus:**
- Linux: vcan интерфейс
- macOS: эмуляция через socket
- Генерация стандартных CAN сообщений

**GPS:**
- gpsd для эмуляции GPS
- NMEA сообщения
- Настраиваемые координаты

**Bluetooth:**
- BlueZ эмуляция (Linux)
- Виртуальный адаптер

## Технологический стек

### Вариант 1: Python (быстрый прототип)
- **GUI:** PyQt6
- **QEMU:** subprocess + pexpect
- **CAN:** python-can
- **Логирование:** logging + loguru
- **Мониторинг:** psutil

### Вариант 2: C++ (оптимальная производительность)
- **GUI:** Qt6
- **QEMU:** QProcess
- **CAN:** SocketCAN
- **Логирование:** spdlog
- **Мониторинг:** системные вызовы

**Рекомендация:** Начать с Python для быстрой разработки, затем оптимизировать критичные части на C++.

## Структура проекта

```
t18fl3_emulator/
├── gui/
│   ├── main_window.py          # Главное окно
│   ├── display1_widget.py       # Дисплей 1 (Instrument)
│   ├── display2_widget.py      # Дисплей 2 (Multimedia)
│   ├── log_viewer.py           # Просмотр логов
│   └── control_panel.py       # Панель управления
├── core/
│   ├── qemu_manager.py         # Управление QEMU
│   ├── log_manager.py          # Логирование
│   ├── can_simulator.py        # CAN-шина
│   ├── image_manager.py       # Управление образами
│   ├── process_monitor.py     # Мониторинг
│   └── device_emulator.py     # Эмуляция устройств
├── config/
│   ├── emulator_config.json    # Конфигурация
│   └── can_messages.json       # CAN сообщения
├── logs/
│   └── (логи сохраняются здесь)
├── resources/
│   └── (ресурсы GUI)
└── main.py                     # Точка входа
```

## Логирование

### Уровни
- DEBUG: Детальная отладочная информация
- INFO: Общая информация о работе
- WARN: Предупреждения
- ERROR: Ошибки
- CRITICAL: Критические ошибки

### Источники
- QEMU stdout/stderr
- Системные процессы
- CAN сообщения
- Сетевой трафик
- Пользовательские действия

### Формат
```
[YYYY-MM-DD HH:MM:SS.mmm] [LEVEL] [SOURCE] Message
```

## CAN-шина симуляция

### Поддерживаемые сообщения
- Климат-контроль
- Скорость автомобиля
- Обороты двигателя
- Положение педалей
- Системы безопасности
- Датчики парковки

### Формат
- CAN 2.0A/B
- Стандартные ID
- Периодические сообщения
- Событийные сообщения

## Производительность

### Оптимизации
- Кэширование образов
- Асинхронная обработка
- Многопоточность для GUI
- Оптимизация QEMU параметров

### Требования
- CPU: 4+ cores
- RAM: 8GB+ (4GB для эмуляции + 4GB для системы)
- Disk: SSD рекомендуется
- GPU: для ускорения QEMU (опционально)

## Безопасность

- Изоляция процессов QEMU
- Проверка целостности образов
- Логирование всех действий
- Защита от случайных изменений образов

