# Карта зависимостей эмулятора

## Структура модулей

```
main.py
└─► core.api (FastAPI app)
    │
    ├─► core.state_manager
    │   ├─► core.state
    │   └─► core.state_persistence
    │       └─► core.state
    │
    ├─► core.ignition_controller
    │   ├─► core.state
    │   ├─► core.config
    │   ├─► core.state_manager
    │   ├─► core.emulator
    │   └─► core.qnx_vm
    │
    ├─► core.emulator (EmulatorManager)
    │   ├─► core.process_cleanup
    │   └─► core.boot_extractor (не используется, можно удалить)
    │
    ├─► core.qnx_vm (QnxVmManager)
    │   ├─► core.process_cleanup
    │   └─► core.emulator (EmulatorConfig)
    │
    ├─► core.can_server
    │   └─► core.qnx (CanFrame)
    │
    ├─► core.display_frames (DisplayFrameManager)
    │   └─► core.graphics_vnc (провайдеры)
    │       └─► core.vnc_client (VncClient)
    │
    ├─► core.boot_monitor
    │   ├─► psutil
    │   └─► core.qemu_monitor (QemuMonitor)
    │
    ├─► core.qnx
    │   ├─► qnx_console
    │   ├─► qnx_pl011_console
    │   ├─► qnx_virtio_console
    │   └─► can_bus (CanBus)
    │
    └─► core.api_controls
        └─► core.controls
```

## Внешние зависимости

### Python пакеты (requirements.txt)
- `fastapi` - Web framework
- `uvicorn[standard]` - ASGI server
- `pydantic` - Data validation
- `pyyaml` - YAML parsing
- `Pillow` - Image processing (PNG encoding)
- `psutil` - Process monitoring

### Системные зависимости
- `qemu-system-aarch64` - QEMU эмулятор (собранный)
- `adb` - Android Debug Bridge (опционально, для logcat)
- `lz4` - LZ4 decompression (опционально, для kernel)

## Незадействованные модули

### can_bridge.py
- **Статус:** Используется в Docker контейнере (`docker/can-bridge/`)
- **Назначение:** Мост между TCP socket и Linux socketcan
- **Действие:** Оставить (используется в Docker)

### boot_extractor.py
- **Статус:** Импортируется в `emulator.py`, но не используется
- **Назначение:** Извлечение kernel из boot.img
- **Действие:** Удалить импорт (функция не используется)

### Swift файлы
- **Статус:** Не используются в Python коде
- **Назначение:** Будущее нативное macOS приложение
- **Действие:** Оставить (планируется использование)

## Пути к файлам

### Текущая реализация (неунифицированная)

1. **Repo root** (`parents[3]`):
   - `emulator.py`
   - `qnx_vm.py`
   - `can_server.py`
   - `graphics_vnc.py`
   - `display_frames.py`

2. **Emulator dir** (`parent.parent`):
   - `api.py` (BASE_DIR)
   - `config.py` (DATA_DIR, LOGS_DIR)
   - `state_persistence.py` (STATE_FILE)

### Рекомендация

Использовать централизованный модуль `core.paths` для всех путей:
- `get_repo_root()` - корень репозитория
- `get_emulator_dir()` - директория эмулятора
- `get_data_dir()` - директория данных
- `get_logs_dir()` - директория логов
- `get_config_path()` - путь к конфигу

## Порты

| Порт | Компонент | Назначение |
|------|-----------|------------|
| 8090 | FastAPI | API сервер |
| 5557 | QEMU Android | ADB (hostfwd) |
| 5558 | QEMU Android | QEMU Monitor |
| 5559 | QEMU QNX | QEMU Monitor |
| 5900 | QEMU Android | VNC HU Display |
| 5901 | QEMU QNX | VNC Cluster Display |
| 1236 | QEMU QNX | virtio-console |
| 1237 | QEMU QNX | PL011 console |
| 1238 | CanServer | CAN Server TCP |
| 1239 | QEMU QNX | UART2 |

## Файлы и директории

### Обязательные
- `emulator_config.yaml` - конфигурация образов
- `data/vehicle_state.json` - сохраненное состояние
- `logs/` - логи работы
- `payload/` - образы системы (boot.img, system.img, etc.)

### Опциональные
- `qemu_g6sh/` - собранный QEMU для g6sh
- `qemu_scif_fork/` - собранный QEMU для QNX
- `web/` - Web UI
- `swift/` - Swift приложение (будущее)

## Импорты

### Правильные (относительные)
```python
from .state import IgnitionState
from .config import config
```

### Неправильные (исправлены)
```python
# Было:
from core.state import IgnitionState
# Стало:
from .state import IgnitionState
```

## Зависимости между компонентами

### State Management
```
StateManager
  └─► StatePersistence
      └─► VehicleState (dataclass)
```

### Emulator Management
```
EmulatorManager ──► QEMU process
QnxVmManager ──► QEMU process (отдельный)
```

### Display Management
```
DisplayFrameManager
  └─► GraphicsVNC (провайдеры)
      └─► VncClient (подключение к VNC)
```

### CAN Management
```
CanServer ──► SocketCAN / TCP
CanBus (модель) ──► CanServer
```

### Boot Monitoring
```
BootMonitor
  ├─► psutil (процессы)
  ├─► QemuMonitor (монитор QEMU)
  └─► socket (порты)
```

## Цепочка запуска

1. `main.py` → `uvicorn.run(core.api.app)`
2. `api.py::startup_event()` → инициализация:
   - `StateManager()` → восстановление состояния
   - `IgnitionController()` → управление зажиганием
   - `BootMonitor()` → мониторинг загрузки
3. API endpoints → управление эмуляторами
4. `IgnitionController` → автоматический запуск эмуляторов
5. `EmulatorManager` / `QnxVmManager` → запуск QEMU процессов

