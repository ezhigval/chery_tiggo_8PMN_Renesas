# Техническое задание

**Проект:** Интеграция Яндекс Навигатора и Яндекс Музыки в систему Chery Tiggo 8 Pro Max  
**Версия:** 1.0  
**Дата:** 2024  
**Статус:** В разработке

---

## 1. Навигация вместо штатной системы

### 1.1. Общие требования

**Цель:** Заменить штатную систему навигации TurboDog на Яндекс Навигатор с полной интеграцией в систему автомобиля.

**Требования:**
- Яндекс Навигатор должен работать как штатная навигация
- Все функции штатной навигации должны быть доступны
- Интеграция должна быть "бесшовной" - пользователь не должен замечать разницы

### 1.2. Отображение на приборной панели

#### 1.2.1. Карта
- **Требование:** Упрощенная версия карты с маршрутом
- **Элементы:**
  - Линия маршрута
  - Текущее местоположение (стрелка "это вы")
  - Ближайший маневр (иконка)
- **Обновление:** В реальном времени (не реже 1 Гц)
- **Формат данных:** Изображение (bitmap) или координаты для отрисовки системой

#### 1.2.2. Информация о маневрах
- **Требование:** Отображение в специальном месте на приборной панели
- **Данные:**
  - Тип маневра (поворот налево/направо, прямо, разворот и т.д.)
  - Расстояние до маневра (в метрах)
  - Время до маневра (в секундах)
- **Обновление:** В реальном времени при изменении маневра

#### 1.2.3. Строка состояния маршрута
- **Требование:** Информация о маршруте с нестандартным позиционированием
- **Данные:**
  - Оставшееся расстояние (в метрах/километрах)
  - Оставшееся время (в минутах/часах)
  - Текущая дорога (название)
  - Следующая дорога (название)
- **Позиционирование:** Вписывается в интерфейс приборной панели

#### 1.2.4. Ограничение скорости
- **Требование:** Брать ограничение скорости из Яндекс Навигатора
- **Отображение:**
  - В специальном "окошке" на приборной панели
  - На спидометре (красная полоска по периметру)
  - На проекции (HUD), если доступно
- **Обновление:** В реальном времени при изменении ограничения
- **Источник данных:** `Guidance.getSpeedLimit()` из Яндекс Навигатора

### 1.3. Механизм интеграции

#### 1.3.1. Извлечение данных
- **Источник:** Яндекс Навигатор (Yandex MapKit SDK)
- **Классы:**
  - `Guidance` - основной интерфейс навигации
  - `Windshield` - информация о предстоящих маневрах
  - `UpcomingManoeuvre` - информация о маневре
  - `RoutePosition` - позиция на маршруте
  - `DrivingRoute` - маршрут

#### 1.3.2. Отправка данных
- **Механизм:** Broadcast Intent
- **Action:** `turbodog.navigation.system.message`
- **Формат данных:** См. раздел "Форматы данных"

### 1.4. Форматы данных

#### 1.4.1. Broadcast Intent для навигационных данных

```java
Intent intent = new Intent("turbodog.navigation.system.message");
intent.putExtra("CODE", 200);
intent.putExtra("DATA", 0);

// Маневры
intent.putExtra("TURN_TYPE", turnType);        // код типа поворота
intent.putExtra("TURN_DIST", turnDistance);     // расстояние до маневра (м)
intent.putExtra("TURN_TIME", turnTime);         // время до маневра (сек)

// Маршрут
intent.putExtra("REMAINING_DIST", remainingDistance); // оставшееся расстояние (м)
intent.putExtra("REMAINING_TIME", remainingTime);     // оставшееся время (сек)
intent.putExtra("ARRIVE_TIME", arriveTime);           // время прибытия

// Дороги
intent.putExtra("CURRENT_ROAD", currentRoad);  // текущая дорога
intent.putExtra("NEXT_ROAD", nextRoad);         // следующая дорога

// Карта (если поддерживается)
if (mapImage != null) {
    intent.putExtra("MAP_IMAGE", bitmapToByteArray(mapImage));
}

sendBroadcast(intent);
```

#### 1.4.2. Маппинг типов маневров

| Яндекс Навигатор (Action) | Код для системы |
|---------------------------|-----------------|
| `LEFT` | Поворот налево |
| `RIGHT` | Поворот направо |
| `STRAIGHT` | Прямо |
| `UTURN_LEFT` / `UTURN_RIGHT` | Разворот |
| `HARD_LEFT` | Резкий поворот налево |
| `HARD_RIGHT` | Резкий поворот направо |
| `ENTER_ROUNDABOUT` | Въезд на кольцо |
| `LEAVE_ROUNDABOUT` | Съезд с кольца |
| `FINISH` | Прибытие |

---

## 2. Вывод на приборную панель

### 2.1. Общие требования

**Цель:** Обеспечить вывод всех навигационных данных на приборную панель в формате, совместимом со штатной системой.

### 2.2. Компоненты системы

#### 2.2.1. SVMapService
- **Назначение:** Мост между навигаторами и системой
- **Поддержка:** AutoNavi, Thinkware, TurboDog
- **Механизм:** Broadcast Intents

#### 2.2.2. SVMeterInteraction
- **Назначение:** Взаимодействие с приборной панелью
- **Функции:**
  - Получение данных от навигации
  - Отправка данных в QNX систему
  - Отображение на приборной панели

### 2.3. Механизм передачи данных

#### 2.3.1. Broadcast Intent
- **Action:** `turbodog.navigation.system.message`
- **Получатель:** SVMeterInteraction или QNX система
- **Формат:** Intent с extras (см. раздел "Форматы данных")

#### 2.3.2. Альтернативные механизмы (требуют исследования)
- System Properties
- Shared Memory
- Unix Sockets (для QNX)

### 2.4. Ограничение скорости

#### 2.4.1. Источник данных
- **Основной:** Яндекс Навигатор (`Guidance.getSpeedLimit()`)
- **Резервный:** Настройки системы (если навигация не активна)

#### 2.4.2. Механизм отправки
- **Через CarInfoProxy:** `sendItemValue(0, 64, value)` (требует исследования)
- **Через Broadcast Intent:** (требует исследования)
- **Через System Property:** (требует исследования)

#### 2.4.3. Места отображения
1. **Окошко на приборной панели:** Специальное место для отображения ограничения скорости
2. **Спидометр:** Красная полоска по периметру спидометра
3. **Проекция (HUD):** Если доступно

---

## 3. Яндекс Музыка в стандартных источниках медиа

### 3.1. Общие требования

**Цель:** Интегрировать Яндекс Музыку в систему мультимедиа автомобиля как стандартный источник.

### 3.2. Требования к интеграции

#### 3.2.1. Отображение в списке источников
- Яндекс Музыка должна отображаться в списке источников медиа
- Иконка и название должны соответствовать стилю системы
- Автоматическое определение при запуске приложения

#### 3.2.2. Управление воспроизведением
- Стандартные кнопки управления (play/pause, next/previous)
- Голосовое управление (если доступно)
- Управление с руля (если доступно)

#### 3.2.3. Отображение метаданных на приборной панели
- **Требование:** Метаданные трека должны отображаться на приборной панели
- **Данные:**
  - Название трека
  - Исполнитель
  - Альбом (если доступно)
  - Обложка альбома (если доступно)
- **Обновление:** В реальном времени при смене трека

### 3.3. Механизм интеграции

#### 3.3.1. Модификация SVMedia
- Добавление источника "Яндекс Музыка"
- Автоопределение при запуске приложения
- Интеграция с MediaSession API

#### 3.3.2. Получение метаданных
- **Механизм:** MediaSession API
- **Источник:** Яндекс Музыка (MediaSession)
- **Данные:** Метаданные трека через MediaController

#### 3.3.3. Отправка метаданных
- **Механизм:** Broadcast Intent
- **Получатель:** SVMeterInteraction
- **Формат:** Существующий формат для метаданных медиа

### 3.4. Компоненты системы

#### 3.4.1. SVMedia
- **Назначение:** Главное приложение мультимедиа
- **Функции:** Выбор источника, управление воспроизведением

#### 3.4.2. SVMediaService
- **Назначение:** Фоновый сервис для управления медиа
- **Функции:** Обработка команд, управление источниками

#### 3.4.3. SVMediaProvider
- **Назначение:** Провайдер медиа
- **Функции:** Предоставление данных о медиа

---

## 4. Дополнительные направления

### 4.1. Голосовое управление

**Статус:** Запланировано

**Требования:**
- Интеграция Яндекс Алисы вместо штатного помощника
- Управление функциями автомобиля (окна, кондиционер и т.д.)
- Управление навигацией и медиа

### 4.2. Кастомный лаунчер

**Статус:** Запланировано

**Требования:**
- Скрытие системных приложений
- Отображение только интегрированных приложений
- Удобный интерфейс для доступа к функциям

---

## 5. Технические требования

### 5.1. Совместимость

- **Система:** Android 8.1 (API 27)
- **Устройство:** Chery Tiggo 8 Pro Max
- **Прошивка:** T18FL3 703000765AA MOD SW 02.09.00

### 5.2. Безопасность

- **Подход:** App Package (без модификации прошивки)
- **Обратимость:** Все изменения должны быть обратимы
- **Подпись:** Использование системных разрешений без root

### 5.3. Производительность

- **Обновление данных:** Не реже 1 Гц для навигации
- **Задержка:** Не более 100 мс для критичных данных
- **Потребление ресурсов:** Минимальное влияние на систему

---

## 6. Форматы данных (детализация)

### 6.1. Навигационные данные

#### 6.1.1. Маневры
- **TURN_TYPE:** Integer (код типа поворота)
- **TURN_DIST:** Integer (расстояние в метрах)
- **TURN_TIME:** Integer (время в секундах)

#### 6.1.2. Маршрут
- **REMAINING_DIST:** Integer (расстояние в метрах)
- **REMAINING_TIME:** Integer (время в секундах)
- **ARRIVE_TIME:** String (время прибытия, формат: "HH:MM")

#### 6.1.3. Дороги
- **CURRENT_ROAD:** String (название текущей дороги)
- **NEXT_ROAD:** String (название следующей дороги)

#### 6.1.4. Карта
- **MAP_IMAGE:** Byte array (изображение карты в формате PNG)

### 6.2. Метаданные медиа

#### 6.2.1. Трек
- **TITLE:** String (название трека)
- **ARTIST:** String (исполнитель)
- **ALBUM:** String (альбом, опционально)
- **ARTWORK:** Byte array (обложка альбома, опционально)

---

## 7. Статус реализации

### 7.1. Исследование
- ✅ Анализ системы и структуры прошивки
- ✅ Декомпиляция ключевых приложений
- ✅ Изучение механизмов интеграции
- ✅ Анализ Яндекс Навигатора
- ✅ Анализ системных компонентов

### 7.2. Разработка
- ⏳ Bridge Service (запланировано)
- ⏳ MapRenderer (запланировано)
- ⏳ DataExtractor (запланировано)
- ⏳ SystemSender (запланировано)
- ⏳ Модификация SVMedia (запланировано)

### 7.3. Интеграция
- ⏳ Интеграция с системой автомобиля (запланировано)
- ⏳ Тестирование на реальном устройстве (запланировано)

---

## 8. История изменений

### Версия 1.0 (2024)
- Создано техническое задание
- Определены все направления интеграции
- Описаны форматы данных
- Определены требования к каждому компоненту

---

**Примечание:** Этот документ является живым документом и будет обновляться по мере получения новых деталей и уточнения требований.

