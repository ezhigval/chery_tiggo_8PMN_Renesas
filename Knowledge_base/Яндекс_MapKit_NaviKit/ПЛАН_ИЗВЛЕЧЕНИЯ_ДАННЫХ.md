# План извлечения данных из Yandex NaviKit

## Архитектура потока данных

```
┌─────────────────────────────────────┐
│  Yandex Maps APK (модифицированный) │
│  TiggoBridgeSenderForAPK.java       │
└──────────────┬──────────────────────┘
               │
               │ Reflection API
               │
               ▼
┌─────────────────────────────────────┐
│  NaviKit Classes (через Reflection) │
│  - Guidance                          │
│  - Windshield                        │
│  - DrivingRoute                     │
│  - Location                          │
└──────────────┬──────────────────────┘
               │
               │ Broadcast Intent
               │
               ▼
┌─────────────────────────────────────┐
│  BridgeService                       │
│  - Прием данных                     │
│  - Разворачивание до итоговых       │
│    значений                          │
└──────────────┬──────────────────────┘
               │
       ┌───────┴────────┐
       │                │
       ▼                ▼
┌─────────────┐  ┌──────────────┐
│     UI      │  │     QNX      │
│ Dashboard   │  │  Приборка    │
│ HUD         │  │  Проекция    │
│ Status      │  │              │
└─────────────┘  └──────────────┘
```

## 1. Ограничение скорости (Speed Limit)

### Источники данных (в порядке приоритета):

1. **Guidance.getSpeedLimit()** → `@Nullable LocalizedValue`

   ```java
   LocalizedValue speedLimit = guidance.getSpeedLimit();
   if (speedLimit != null) {
       double valueMs = speedLimit.getValue(); // м/с
       int valueKmh = (int) Math.round(valueMs * 3.6); // конвертация в км/ч
       String text = speedLimit.getText(); // "60 km/h"
   }
   ```

2. **Windshield.getSpeedLimit()** → объект с `getValue()`

   ```java
   Windshield windshield = guidance.getWindshield();
   Object speedLimitObj = windshield.getSpeedLimit();
   // Извлечь значение через getValue()
   ```

3. **Guidance.getSpeedLimitStatus()** → `@NonNull SpeedLimitStatus`
   ```java
   SpeedLimitStatus status = guidance.getSpeedLimitStatus();
   // Пробуем извлечь значение через методы status
   ```

### Отправка в BridgeService:

```java
intent.putExtra("speedLimit", speedLimit); // int в км/ч
intent.putExtra("speedLimitText", speedLimitText); // String "60 km/h"
```

## 2. Маневры (Manoeuvres)

### Источник данных:

**Windshield.getUpcomingManoeuvres()** → `List<Manoeuvre>`

```java
Windshield windshield = guidance.getWindshield();
List<Manoeuvre> manoeuvres = windshield.getUpcomingManoeuvres();

// Фильтруем камеры скорости
for (Manoeuvre m : manoeuvres) {
    if (!isSpeedCamera(m)) {
        String title = extractTitle(m); // "Поверните налево"
        String subtitle = extractSubtitle(m); // "на улицу Ленина"
        double distance = extractDistance(m); // метры
        break;
    }
}
```

### Отправка в BridgeService:

```java
intent.putExtra("maneuverTitle", title);
intent.putExtra("maneuverSubtitle", subtitle);
intent.putExtra("maneuverDistance", distance); // метры
intent.putExtra("maneuverType", maneuverType); // код типа маневра
```

## 3. Маршрут (Route Geometry - Полилинии)

### Источник данных:

**Guidance.getCurrentRoute()** → `@Nullable DrivingRoute`

```java
DrivingRoute route = guidance.getCurrentRoute();
if (route != null) {
    // Методы для получения геометрии (нужно найти в документации):
    // - getGeometry() или getPolyline() или getPoints()
    // Возвращает список точек (Point) или полилинию
}
```

### Отправка в BridgeService:

```java
// Вариант 1: Список точек
List<Point> routePoints = extractRoutePoints(route);
intent.putParcelableArrayListExtra("routePoints", routePoints);

// Вариант 2: Полилиния (encoded string)
String polyline = encodePolyline(routePoints);
intent.putExtra("routePolyline", polyline);
```

## 4. Статус маршрута (Route Status)

### Источник данных:

**Guidance.getRouteStatus()** → `@NonNull RouteStatus`

```java
RouteStatus status = guidance.getRouteStatus();
// Методы для получения статуса (нужно найти в документации):
// - isActive(), isCompleted(), getProgress() и т.д.
```

### Отправка в BridgeService:

```java
intent.putExtra("routeStatus", routeStatus); // String или int код
intent.putExtra("hasRoute", hasRoute); // boolean
intent.putExtra("routeProgress", progress); // 0.0 - 1.0
```

## 5. События на карте (Map Events)

### Источники данных:

1. **Windshield** - события для HUD

   ```java
   Windshield windshield = guidance.getWindshield();
   // Методы для получения событий (камеры, дорожные события)
   ```

2. **Guidance.getAnnotator()** → `@NonNull Annotator`
   ```java
   Annotator annotator = guidance.getAnnotator();
   // Методы для получения аннотаций на карте
   ```

### Отправка в BridgeService:

```java
List<MapEvent> events = extractMapEvents(windshield, annotator);
intent.putParcelableArrayListExtra("mapEvents", events);
// MapEvent содержит: type, location, description
```

## 6. Карта (Map Data)

### Источник данных:

**Guidance.getLocation()** → `@Nullable Location`

```java
Location location = guidance.getLocation();
if (location != null) {
    Point position = location.getPosition();
    double lat = position.getLatitude();
    double lon = position.getLongitude();
    float bearing = location.getBearing(); // направление движения
}
```

### Отправка в BridgeService:

```java
intent.putExtra("currentLat", lat);
intent.putExtra("currentLon", lon);
intent.putExtra("bearing", bearing);
intent.putExtra("currentRoad", roadName); // из Guidance.getRoadName()
```

## 7. Дополнительные данные маршрута

### Источник данных:

**Guidance.getCurrentRoute()** → `DrivingRoute`

```java
DrivingRoute route = guidance.getCurrentRoute();
if (route != null) {
    // Методы для получения:
    // - getDistance() - оставшееся расстояние
    // - getDuration() - оставшееся время
    // - getTrafficJams() - пробки на маршруте
}
```

### Отправка в BridgeService:

```java
intent.putExtra("remainingDistance", distance); // метры
intent.putExtra("remainingTime", time); // секунды
intent.putExtra("timeOfArrival", timeOfArrival); // timestamp
```

## Реализация в TiggoBridgeSenderForAPK.java

### Структура метода extractAndSendCurrentData():

```java
public void extractAndSendCurrentData() {
    // 1. Получаем Guidance объект
    Object guidance = getGuidance();
    if (guidance == null) return;

    // 2. Извлекаем данные согласно документации
    int speedLimit = extractSpeedLimit(guidance);
    ManeuverData maneuver = extractManeuver(guidance);
    RouteGeometry routeGeometry = extractRouteGeometry(guidance);
    RouteStatus routeStatus = extractRouteStatus(guidance);
    LocationData location = extractLocation(guidance);
    List<MapEvent> events = extractMapEvents(guidance);

    // 3. Отправляем через Broadcast Intent
    sendNavigationData(speedLimit, maneuver, routeGeometry,
                       routeStatus, location, events);
}
```

## Следующие шаги

1. ✅ Изучить документацию NaviKit
2. ⏳ Найти точные методы для получения геометрии маршрута
3. ⏳ Найти точные методы для получения статуса маршрута
4. ⏳ Найти точные методы для получения событий на карте
5. ⏳ Реализовать извлечение всех данных согласно документации
6. ⏳ Обновить BridgeService для приема и обработки всех данных
7. ⏳ Реализовать отправку в QNX
