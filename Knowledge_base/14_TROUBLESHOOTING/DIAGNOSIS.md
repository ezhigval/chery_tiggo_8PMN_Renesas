# Диагностика проблемы запуска T18FL3

## Текущая ситуация

✅ **Что работает:**

- QEMU процесс запускается успешно (PID найден)
- Мониторинг потоков запущен
- Serial порт настроен как stdio
- Образы найдены и подключены

❌ **Что не работает:**

- Serial output не появляется в логах
- Мониторы не показывают изображение
- ADB devices не показывает устройство

## Анализ проблемы

### 1. Serial Output не появляется

**Симптом:** В логах нет сообщений "FIRST DATA RECEIVED" от monitor thread

**Возможные причины:**

#### A. Kernel не загружается

- QEMU может не загружать kernel из-за неправильного адреса загрузки
- Проблема с форматом kernel (LZ4 сжатие)
- Неправильный DTB (Device Tree Blob)

**Диагностика:**

```bash
# Проверить что QEMU процесс работает
ps aux | grep qemu-system-aarch64

# Проверить логи QEMU напрямую (если есть)
# Или использовать наш realtime_log_monitor.py
```

#### B. Проблема с чтением stdout

- На macOS может быть проблема с неблокирующим чтением pipe
- Буферизация stdout может задерживать вывод
- select() может не работать с pipe на macOS

**Решение:**

- Проверить что monitor thread действительно читает данные
- Попробовать использовать unbuffered режим
- Использовать альтернативный метод чтения (dtrace/strace)

#### C. Kernel загружается но не выводит в serial

- Kernel может быть настроен на вывод в другой консоль
- Проблема с параметрами cmdline (console=ttyAMA0)
- Kernel может падать до начала вывода

### 2. Мониторы не показывают изображение

**Симптом:** VNC порты открыты, но экран черный

**Возможные причины:**

#### A. Android не запустился

- Kernel загрузился, но init не запустился
- Проблема с монтированием файловых систем
- Ошибки в init.rc

#### B. Графический драйвер не работает

- virtio-gpu не инициализирован
- Проблема с разрешением (3840x720)
- Framebuffer не создан

#### C. VNC не подключен правильно

- Неправильный display номер
- Проблема с портом 5910

### 3. ADB не работает

**Симптом:** `adb devices` не показывает устройство

**Возможные причины:**

#### A. Android не загрузился полностью

- Система зависла на этапе загрузки
- adbd не запустился

#### B. Сеть не настроена

- Проблема с port forwarding (5556->5555)
- virtio-net не работает

## План диагностики

### Шаг 1: Проверить что QEMU действительно запущен

```bash
python3 realtime_log_monitor.py
```

Смотрим:

- Найден ли процесс QEMU?
- Открыты ли порты?
- Есть ли serial output?

### Шаг 2: Проверить serial output напрямую

Если serial output не появляется, возможно:

1. Kernel не загружается - нужно проверить параметры загрузки
2. Проблема с чтением - нужно улучшить monitor thread

### Шаг 3: Проверить QEMU monitor

Подключиться к QEMU monitor (порт 4445):

```bash
telnet 127.0.0.1 4445
```

Команды для проверки:

```
info status
info registers
info network
info qtree
```

### Шаг 4: Проверить логи kernel

Если есть доступ к serial output, искать:

- "Booting Linux" - kernel начал загружаться
- "Kernel command line" - параметры загрузки
- "init: starting" - Android init запустился
- "Kernel panic" - критическая ошибка

## Рекомендации

1. **Запустить realtime_log_monitor.py** для детального мониторинга
2. **Проверить QEMU monitor** для получения информации о состоянии VM
3. **Улучшить чтение serial output** если проблема в monitor thread
4. **Проверить параметры загрузки kernel** если kernel не загружается

## Следующие шаги

1. Запустить `realtime_log_monitor.py` и посмотреть что происходит
2. Если serial output не появляется - проверить почему monitor thread не читает данные
3. Если kernel не загружается - проверить параметры загрузки и адреса
4. Если Android не запускается - проверить serial output на ошибки init
