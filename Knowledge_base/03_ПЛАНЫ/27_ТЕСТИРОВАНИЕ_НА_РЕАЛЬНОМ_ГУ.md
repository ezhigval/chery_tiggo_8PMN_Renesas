# Тестирование на реальном головном устройстве (ГУ)

## Подготовка

### 1. Подключение ADB

```bash
# Проверить подключение
adb devices

# Если устройство не видно, проверьте:
# - USB отладка включена на ГУ
# - Драйверы установлены
# - Кабель поддерживает передачу данных
```

### 2. Установка приложения

```bash
# Установить APK
adb install -r development/projects/TiggoBridgeService/app/build/outputs/apk/debug/app-debug.apk

# Если установка не удается (старая версия):
adb uninstall com.desaysv.tiggo.bridge
adb install development/projects/TiggoBridgeService/app/build/outputs/apk/debug/app-debug.apk
```

### 3. Включение NotificationListenerService

**На реальном ГУ может не быть стандартных настроек Android**, поэтому используем ADB:

```bash
# Включить NotificationListenerService
adb shell settings put secure enabled_notification_listeners com.desaysv.tiggo.bridge/.notification.NavigationNotificationListener

# Проверить статус
adb shell settings get secure enabled_notification_listeners
```

**Ожидаемый результат:**
```
com.desaysv.tiggo.bridge/.notification.NavigationNotificationListener
```

## Тестирование

### Шаг 1: Запуск приложения

1. Запустите приложение **Tiggo Bridge** на ГУ
2. Проверьте логи:
   ```bash
   adb logcat | grep -E '(NavNotificationListener|NotificationListenerHelper|BridgeService)'
   ```

**Ожидаемые сообщения:**
```
BridgeService: Проверка статуса NotificationListenerService...
NotificationListenerHelper: NotificationListenerService включен
BridgeService: ✓ NotificationListenerService уже включен
NavigationNotificationListener: === NavigationNotificationListener создан ===
NavigationNotificationListener: ✓ NotificationListenerService активен, RankingMap получен
```

### Шаг 2: Запуск навигации

1. **Запустите Yandex Navigator** на ГУ
2. **Постройте маршрут** (укажите точку назначения)
3. **Начните навигацию** (нажмите "Начать" или "В путь")
4. **Проверьте, что появились уведомления** в шторке уведомлений

### Шаг 3: Мониторинг перехвата

```bash
# Очистить логи
adb logcat -c

# Мониторить перехват уведомлений
adb logcat | grep -E '(NavNotificationListener|NotificationParser)'
```

**Ожидаемые сообщения при активной навигации:**

```
NavNotificationListener: onNotificationPosted вызван для пакета: ru.yandex.yandexnavi
NavNotificationListener: === Получено уведомление от Yandex Navigator ===
NavNotificationListener: Данные уведомления:
NavNotificationListener:   title: Поверните направо через 200 м
NavNotificationListener:   text: Осталось 5.2 км, 12 мин
NotificationParser: Парсинг: title='Поверните направо через 200 м', text='Осталось 5.2 км, 12 мин'
NotificationParser: Расстояние до маневра: 200м
NotificationParser: Оставшееся расстояние: 5200м
NotificationParser: Оставшееся время: 720сек
NavNotificationListener: ✓ Данные навигации извлечены:
NavNotificationListener:   TURN_TYPE: 1
NavNotificationListener:   TURN_DIST: 200м
NavNotificationListener:   REMAINING_DIST: 5200м
NavNotificationListener:   REMAINING_TIME: 720сек
NavNotificationListener: ✓ Данные отправлены в BridgeService
BridgeService: Получены данные навигации от NotificationListener
BridgeService: ✓ Данные от NotificationListener отправлены в QNX: TURN=1, DIST=200м
```

### Шаг 4: Проверка в приложении

1. Откройте приложение **Tiggo Bridge** на ГУ
2. Перейдите на вкладку **Статус**
3. Проверьте индикаторы:
   - ✅ Сервис активен (зеленый)
   - ✅ Навигатор запущен (синий/зеленый)
   - ✅ Навигация активна (зеленый) - если маршрут активен
4. Перейдите на вкладку **Логи**
5. Должны быть сообщения о получении данных

## Устранение проблем

### NotificationListenerService не включается

```bash
# Попробовать включить снова
adb shell settings put secure enabled_notification_listeners com.desaysv.tiggo.bridge/.notification.NavigationNotificationListener

# Проверить статус
adb shell settings get secure enabled_notification_listeners

# Если не работает, возможно нужны системные разрешения
# На ГУ приложение может быть установлено как системное
```

### Уведомления не перехватываются

1. **Проверьте, что навигация активна:**
   - Маршрут должен быть построен
   - Навигация должна быть запущена (не просто построен маршрут)
   - Yandex Navigator должен показывать уведомления

2. **Проверьте логи onCreate:**
   ```bash
   adb logcat | grep 'NavigationNotificationListener создан'
   ```
   Если нет - сервис не создается

3. **Проверьте все уведомления:**
   ```bash
   adb logcat | grep 'onNotificationPosted вызван'
   ```
   Если нет логов вообще - `onNotificationPosted` не вызывается

4. **Проверьте уведомления от Yandex:**
   ```bash
   adb shell dumpsys notification | grep -A 10 'ru.yandex.yandexnavi'
   ```

### Данные не парсятся

Если уведомления перехватываются, но данные не парсятся:
```bash
# Посмотреть полный текст уведомления
adb logcat | grep -A 5 "Данные уведомления"
```

Возможно, формат уведомлений на ГУ отличается. Нужно будет скорректировать парсер.

## Особенности реального ГУ

1. **Нет стандартных настроек Android** - используем ADB для включения NotificationListenerService
2. **Может быть установлено как системное приложение** - тогда автоматическое включение должно работать
3. **Может быть другой формат уведомлений** - нужно проверить логи
4. **Может быть другая версия Android** - проверить совместимость

## Следующие шаги

Если все работает:
1. ✅ NotificationListenerService включен
2. ✅ Уведомления перехватываются
3. ✅ Данные парсятся
4. ✅ Данные отправляются в QNX

Тогда можно переходить к тестированию на реальной дороге!

