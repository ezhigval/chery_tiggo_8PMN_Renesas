# Инструкция по включению NotificationListenerService

## Что это?

`NotificationListenerService` - это самый простой и надежный способ получения данных навигации от Yandex Navigator. Он перехватывает уведомления, которые показывает навигатор, и извлекает из них данные.

## Преимущества

✅ **Не требует модификации APK** - работает с оригинальным навигатором  
✅ **Легальный способ** - использует официальный Android API  
✅ **Работает с любой версией** - не зависит от версии навигатора  
✅ **Надежно** - получаем данные напрямую из уведомлений  

## Как включить

### Шаг 1: Установить приложение
Установите `TiggoBridgeService` на устройство.

### Шаг 2: Включить NotificationListenerService

1. Откройте **Настройки** Android
2. Перейдите в **Специальные возможности** (Accessibility)
3. Найдите раздел **Услуги** (Services)
4. Найдите **Tiggo Bridge** или **Navigation Notification Listener**
5. Включите переключатель
6. Подтвердите разрешение

**Альтернативный путь:**
- Настройки → Уведомления → Доступ к уведомлениям → Tiggo Bridge

### Шаг 3: Проверить работу

1. Запустите Yandex Navigator
2. Постройте маршрут и начните навигацию
3. Откройте приложение Tiggo Bridge
4. Проверьте вкладку **Статус** - должна быть зеленая лампочка "Навигация активна"
5. Проверьте вкладку **Логи** - должны быть сообщения о получении данных

## Проверка через ADB

```bash
# Проверить, включен ли NotificationListenerService
adb shell dumpsys notification_listener | grep -A 5 "Tiggo"

# Проверить логи
adb logcat | grep -E "(NavNotificationListener|NotificationParser)"
```

## Что происходит

1. Yandex Navigator показывает уведомление с данными навигации
2. `NavigationNotificationListener` перехватывает это уведомление
3. `NotificationDataParser` извлекает данные из текста уведомления
4. Данные отправляются в `BridgeService` через Broadcast Intent
5. `BridgeService` отправляет данные в QNX (приборную панель)

## Формат уведомлений Yandex Navigator

**Title:** "Поверните направо через 200 м"  
**Text:** "Осталось 5.2 км, 12 мин"

Из этих данных мы извлекаем:
- Тип маневра (направо/налево/прямо)
- Расстояние до маневра (200 м)
- Оставшееся расстояние (5.2 км)
- Оставшееся время (12 мин)

## Устранение проблем

### NotificationListenerService не работает

1. Проверьте, что сервис включен в настройках
2. Перезапустите приложение
3. Проверьте логи: `adb logcat | grep NavNotificationListener`

### Данные не приходят

1. Убедитесь, что навигация активна (построен маршрут)
2. Проверьте, что Yandex Navigator показывает уведомления
3. Проверьте логи парсера: `adb logcat | grep NotificationParser`

### Разрешение не дается

На некоторых устройствах нужно:
1. Отключить другие NotificationListenerService
2. Перезагрузить устройство
3. Попробовать включить снова

## Альтернативы

Если NotificationListenerService не работает, можно использовать:
- **AccessibilityService** (уже реализован)
- **Reflection** (через YandexNavigatorDataExtractor)
- **Модификация APK** (сложный способ)

