# Стратегия модификации APK Yandex Navigator

## Текущая ситуация

✅ **APK извлечен:** 163 MB  
✅ **Декомпиляция завершена:** apktool + jadx  
✅ **Класс TiggoBridgeSender готов:** отправляет данные в мост  
✅ **BridgeService готов:** получает данные и отправляет в QNX  

## Проблема: Поиск точки внедрения

Класс `k.java` из старой декомпиляции может иметь другую структуру в новой версии APK.

## Решения

### Вариант 1: Поиск через BaseGuidanceConsumer (Рекомендуется)

**Идея:** Все классы, работающие с навигацией, наследуются от `BaseGuidanceConsumer`.

**Шаги:**
1. Найти все классы, наследующиеся от `BaseGuidanceConsumer`
2. Найти, где они получают `NotificationDataManager`
3. Добавить инициализацию `TiggoBridgeSender` в конструктор или `onHandlerReady`

### Вариант 2: Поиск через addListener

**Идея:** Где-то в коде вызывается `notificationDataManager.addListener()`.

**Шаги:**
1. Найти все места, где вызывается `addListener` для `NotificationDataManager`
2. Добавить наш listener рядом с существующим

### Вариант 3: Глобальная инициализация

**Идея:** Инициализировать `TiggoBridgeSender` в Application классе или главной Activity.

**Шаги:**
1. Найти Application класс или главную Activity
2. Добавить инициализацию в `onCreate()`
3. Использовать reflection для получения `NotificationDataManager` позже

## Рекомендуемый подход: Комбинированный

### Шаг 1: Глобальная инициализация

Добавить инициализацию `TiggoBridgeSender` в Application класс:
```java
// В Application.onCreate()
TiggoBridgeSender.init(this);
```

### Шаг 2: Подключение к NotificationDataManager

Найти место, где создается или получается `NotificationDataManager`, и добавить:
```java
// После получения NotificationDataManager
TiggoBridgeSender.getInstance().attachToNotificationDataManager(notificationDataManager);
```

## Альтернатива: Использование существующего кода

Если сложно найти точку внедрения, можно:

1. **Использовать наш существующий код:**
   - `YandexNavigatorDataExtractor` уже работает через reflection
   - Можно оставить его как есть
   - Модификация APK - это дополнительная оптимизация

2. **Улучшить reflection-метод:**
   - Сделать его более надежным
   - Добавить больше точек получения данных

## Следующие шаги

1. ⏳ Найти Application класс или главную Activity
2. ⏳ Добавить инициализацию TiggoBridgeSender
3. ⏳ Найти место получения NotificationDataManager
4. ⏳ Добавить подключение к NotificationDataManager
5. ⏳ Ре-скомпилировать и протестировать

## Если не найдем точку внедрения

Можно использовать **более простой подход:**

1. Создать отдельное приложение-прокси
2. Которое будет перехватывать данные навигации
3. И отправлять их в наш мост

Но модификация APK все равно предпочтительнее, так как:
- Меньше накладных расходов
- Прямая интеграция
- Не нужны дополнительные приложения

