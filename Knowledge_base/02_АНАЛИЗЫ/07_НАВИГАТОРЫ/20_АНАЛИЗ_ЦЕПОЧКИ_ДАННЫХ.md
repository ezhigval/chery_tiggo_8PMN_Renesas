# Анализ цепочки данных навигации

## Цель

Понять, откуда берутся карты и навигация, какой элемент их запрашивает, где хранятся, как вызываются.

## Главная Activity

**Класс:** `ru.yandex.yandexmaps.app.MapActivity`

**Роль:** Главная точка входа, отображает карту и управляет навигацией.

## Инициализация MapKit

### 1. MapKitFactory

**Где:** В Application классе или при первом использовании

**Код:**
```java
MapKitFactory.setApiKey("API_KEY");
MapKitFactory.initialize(context);
```

**Что делает:**
- Инициализирует Yandex MapKit SDK
- Загружает карты
- Инициализирует навигацию

### 2. MapView

**Где:** В `MapActivity`

**Код:**
```java
MapView mapView = findViewById(R.id.mapview);
mapView.getMap().move(new CameraPosition(...));
```

**Что делает:**
- Отображает карту
- Управляет камерой
- Обрабатывает жесты

## Инициализация навигации

### Цепочка через DI (Dependency Injection)

```
MapActivity.onCreate()
    ↓
DI система инициализируется
    ↓
f3.java.get() → GenericGuidanceComponent.getGenericGuidance()
    ↓
GenericGuidance (обертка для регистрации listeners)
    ↓
p3.java.get() → guidance.notificationDataManager()
    ↓
NotificationDataManager (управляет данными для уведомлений)
    ↓
ConsistentAutomotiveGuidanceConsumer создается с Guidance
    ↓
onHandlerReady() → addListener() для NotificationDataManager
```

### Ключевые классы

#### 1. GenericGuidanceComponent

**Путь:** `com.yandex.navikit.guidance.generic.GenericGuidanceComponent`

**Роль:** Синглтон для получения GenericGuidance

**Код:**
```java
GenericGuidanceComponent.INSTANCE.getGenericGuidance()
```

**Что возвращает:**
- `GenericGuidance` - интерфейс для регистрации Consumer и Handler

#### 2. Guidance

**Путь:** `com.yandex.navikit.guidance.Guidance`

**Роль:** Основной интерфейс навигации

**Как получить:**
- Через DI систему
- Или через `Navigation.getGuidance()` (MapKit)

**Методы:**
- `notificationDataManager()` - получает NotificationDataManager
- `getNextManeuver()` - следующий маневр
- `getRoutePosition()` - позиция на маршруте
- `route()` - текущий маршрут

#### 3. NotificationDataManager

**Путь:** `com.yandex.navikit.guidance.NotificationDataManager`

**Роль:** Управляет данными для уведомлений

**Как получить:**
```java
NotificationDataManager manager = guidance.notificationDataManager();
```

**Методы:**
- `notificationData()` - текущие данные
- `addListener()` - подписка на обновления
- `isValid()` - проверка валидности

#### 4. ConsistentAutomotiveGuidanceConsumer

**Путь:** `ru.yandex.yandexmaps.integrations.auto_navigation.navikit.a`

**Роль:** Consumer для автомобильной навигации

**Наследование:** `BaseAutomotiveGuidanceConsumer`

**Что делает:**
- Получает Guidance в конструкторе
- В `onHandlerReady()` подписывается на обновления
- Обрабатывает данные навигации

## Поток данных

### Инициализация

```
1. Приложение запускается
   ↓
2. MapActivity.onCreate()
   ↓
3. MapKitFactory.initialize() (если еще не инициализирован)
   ↓
4. DI система создает зависимости
   ↓
5. GenericGuidanceComponent.INSTANCE доступен
   ↓
6. Guidance получается через DI
   ↓
7. NotificationDataManager = guidance.notificationDataManager()
   ↓
8. ConsistentAutomotiveGuidanceConsumer создается
   ↓
9. onHandlerReady() вызывается
   ↓
10. notificationDataManager.addListener() вызывается
```

### Получение данных

```
1. Навигация активна
   ↓
2. NotificationDataManager обновляется
   ↓
3. onNotificationDataUpdated() вызывается у всех listeners
   ↓
4. Данные используются для:
   - Уведомлений
   - UI обновлений
   - Отправки в систему (наш случай)
```

## Хранение данных

### В памяти

- `NotificationDataManager` хранит текущие данные в памяти
- Данные обновляются при изменении навигации
- Не сохраняются между сессиями (кроме маршрута)

### Сохранение маршрута

- Маршрут может сохраняться при закрытии навигатора
- Восстанавливается при следующем запуске
- Хранится в `Guidance.route()` или через `RouteBuilder`

## Вызовы

### Построение маршрута

```
1. Пользователь выбирает точки
   ↓
2. RouteBuilder.requestRoutes()
   ↓
3. DrivingRouter строит маршрут
   ↓
4. onDrivingRoutes() callback
   ↓
5. Маршрут отображается на карте
```

### Запуск навигации

```
1. Пользователь нажимает "Начать навигацию"
   ↓
2. guidance.start(route)
   ↓
3. Навигация активируется
   ↓
4. NotificationDataManager начинает обновляться
   ↓
5. Listeners получают данные
```

## Точка внедрения TiggoBridgeSender

### Рекомендуемое место

**В классе, который получает NotificationDataManager:**

1. **DI модуль p3.java:**
   ```java
   NotificationDataManager manager = guidance.notificationDataManager();
   TiggoBridgeSender.getInstance().attachToNotificationDataManager(manager);
   return manager;
   ```

2. **Или в ConsistentAutomotiveGuidanceConsumer:**
   ```java
   // В конструкторе или onHandlerReady()
   NotificationDataManager manager = guidance.notificationDataManager();
   TiggoBridgeSender.getInstance().attachToNotificationDataManager(manager);
   ```

## Выводы

1. **Карты:** Инициализируются через `MapKitFactory`, отображаются через `MapView`
2. **Навигация:** Инициализируется через `GenericGuidanceComponent` и DI систему
3. **Данные:** Получаются через `NotificationDataManager` из `Guidance`
4. **Хранение:** В памяти, маршрут может сохраняться
5. **Вызовы:** Через `RouteBuilder` для построения, `guidance.start()` для запуска

## Следующие шаги

1. ✅ Понять цепочку инициализации
2. ⏳ Найти точное место в новой версии APK
3. ⏳ Добавить TiggoBridgeSender
4. ⏳ Протестировать

