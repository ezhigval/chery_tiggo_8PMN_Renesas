# Альтернативные способы перехвата данных навигации

## Проблема
Модификация APK - сложный и рискованный процесс. Нужны более простые и надежные способы.

## Варианты перехвата

### 1. NotificationListenerService ⭐ (РЕКОМЕНДУЕТСЯ)
**Самый простой и надежный способ!**

Yandex Navigator показывает уведомления с навигацией. Мы можем их перехватывать через `NotificationListenerService`.

**Преимущества:**
- ✅ Не требует модификации APK
- ✅ Работает с любой версией навигатора
- ✅ Легальный способ (системный API Android)
- ✅ Получаем все данные из уведомлений
- ✅ Работает даже когда навигатор в фоне

**Как работает:**
```java
public class NavigationNotificationListener extends NotificationListenerService {
    @Override
    public void onNotificationPosted(StatusBarNotification sbn) {
        if ("ru.yandex.yandexnavi".equals(sbn.getPackageName())) {
            Notification notification = sbn.getNotification();
            Bundle extras = notification.extras;
            
            // Извлекаем данные из уведомления
            String title = extras.getString(Notification.EXTRA_TITLE);
            String text = extras.getString(Notification.EXTRA_TEXT);
            // ... парсим данные и отправляем в BridgeService
        }
    }
}
```

**Разрешения:**
- `BIND_NOTIFICATION_LISTENER_SERVICE` (системное разрешение, пользователь должен включить вручную)

---

### 2. AccessibilityService
**Перехват данных из UI навигатора**

**Преимущества:**
- ✅ Полный доступ к UI элементам
- ✅ Можем читать текст с экрана
- ✅ Можем отслеживать изменения в UI

**Недостатки:**
- ⚠️ Требует включения в настройках доступности
- ⚠️ Может быть медленнее
- ⚠️ Зависит от структуры UI

---

### 3. Системные Intent'ы
**Проверка, отправляет ли Yandex системные Intent'ы**

**Идея:** Yandex Navigator может отправлять системные Intent'ы для интеграции с Android Auto или другими системами.

**Проверка:**
```bash
# Мониторинг всех Intent'ов от Yandex Navigator
adb logcat | grep -i "intent\|broadcast" | grep "yandexnavi"
```

**Если находит Intent'ы:**
- Регистрируем `BroadcastReceiver` для этих Intent'ов
- Получаем данные напрямую

---

### 4. SharedPreferences / ContentProvider
**Проверка общих хранилищ данных**

**Идея:** Yandex Navigator может хранить данные навигации в SharedPreferences или ContentProvider.

**Проблема:**
- ❌ Обычно недоступны из других приложений
- ❌ Требуют root или модификацию APK

**Но можно проверить:**
```bash
# Проверка SharedPreferences
adb shell run-as ru.yandex.yandexnavi ls /data/data/ru.yandex.yandexnavi/shared_prefs/
```

---

### 5. Android Auto API
**Системная интеграция с Android Auto**

**Идея:** Если навигатор поддерживает Android Auto, он может использовать системные API.

**Проверка:**
- Ищем использование `CarNavigationStatusManager`
- Ищем Intent'ы `androidx.car.app.CarAppService`

---

## Рекомендация

### ✅ NotificationListenerService - ЛУЧШИЙ ВАРИАНТ

**Почему:**
1. **Простота** - не требует модификации APK
2. **Надежность** - работает с любой версией навигатора
3. **Легальность** - официальный Android API
4. **Полнота данных** - уведомления содержат всю необходимую информацию

**План реализации:**
1. Создать `NavigationNotificationListener` extends `NotificationListenerService`
2. Зарегистрировать в `AndroidManifest.xml`
3. Пользователь включает в настройках: "Специальные возможности" → "Услуги" → "Tiggo Bridge"
4. Перехватываем уведомления от `ru.yandex.yandexnavi`
5. Парсим данные из `Notification.extras`
6. Отправляем в `BridgeService` → QNX

**Данные в уведомлении:**
- `EXTRA_TITLE` - "Поверните направо через 200 м"
- `EXTRA_TEXT` - "Осталось 5.2 км, 12 мин"
- `EXTRA_BIG_TEXT` - полный текст
- Custom extras - могут содержать структурированные данные

---

## Сравнение методов

| Метод | Сложность | Надежность | Легальность | Рекомендация |
|-------|-----------|------------|-------------|--------------|
| NotificationListenerService | ⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ | ✅✅✅ |
| AccessibilityService | ⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ | ✅✅ |
| Системные Intent'ы | ⭐⭐ | ⭐⭐⭐ | ✅ | ✅✅ |
| SharedPreferences | ⭐⭐⭐⭐ | ⭐⭐ | ⚠️ | ❌ |
| Модификация APK | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⚠️ | ❌ |
| Reflection | ⭐⭐⭐⭐ | ⭐⭐ | ⚠️ | ❌ |

---

## Следующие шаги

1. ✅ Реализовать `NotificationListenerService`
2. ✅ Протестировать на эмуляторе
3. ✅ Парсить данные из уведомлений
4. ✅ Отправить в BridgeService

